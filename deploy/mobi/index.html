<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
<meta name="theme-color" content="#075E54">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MobiPhysio">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icon-192.png">
<title>MobiPhysio</title>
<style>
/* ===== CSS Variables ===== */
:root {
  --wa-dark: #075E54;
  --wa-teal: #128C7E;
  --wa-green: #25D366;
  --wa-light-green: #DCF8C6;
  --wa-blue: #34B7F1;
  --wa-bg: #ECE5DD;
  --wa-chat-bg: #E5DDD5;
  --white: #ffffff;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --success: #22c55e;
  --warning: #f59e0b;
  --danger: #ef4444;
  --shadow: 0 1px 3px rgba(0,0,0,0.12);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --radius: 12px;
  --radius-sm: 8px;
}

/* ===== Reset ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  color: var(--gray-800);
  background: var(--wa-bg);
  line-height: 1.5;
  min-height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
  overflow-x: hidden;
}
a { color: var(--wa-teal); text-decoration: none; }
input, select, textarea, button { font-family: inherit; font-size: inherit; }

/* ===== App Shell ===== */
#app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* ===== Header ===== */
.header {
  background: var(--wa-dark);
  color: var(--white);
  padding: 14px 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-md);
}
.header-title {
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: 0.02em;
}
.header-subtitle {
  font-size: 0.78rem;
  opacity: 0.85;
  margin-top: 1px;
}

/* ===== Content Area ===== */
.content {
  flex: 1;
  padding: 12px;
  padding-bottom: 80px;
  overflow-y: auto;
}

/* ===== Bottom Tab Bar ===== */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  background: var(--white);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 6px 0 env(safe-area-inset-bottom, 8px);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
  z-index: 100;
}
.tab-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 4px 8px;
  border: none;
  background: none;
  color: var(--gray-400);
  font-size: 0.65rem;
  font-weight: 600;
  cursor: pointer;
  position: relative;
  transition: color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.tab-item.active { color: var(--wa-dark); }
.tab-item svg { width: 24px; height: 24px; }
.tab-badge {
  position: absolute;
  top: 0;
  right: 2px;
  background: var(--wa-green);
  color: var(--white);
  font-size: 0.6rem;
  font-weight: 700;
  min-width: 16px;
  height: 16px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
}

/* ===== Login Screen ===== */
.login-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 32px 24px;
  background: linear-gradient(180deg, var(--wa-dark) 0%, var(--wa-teal) 40%, var(--wa-bg) 100%);
}
.login-logo {
  width: 80px;
  height: 80px;
  background: var(--white);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 16px;
  box-shadow: var(--shadow-md);
}
.login-logo svg { width: 48px; height: 48px; fill: var(--wa-dark); }
.login-title { color: var(--white); font-size: 1.6rem; font-weight: 700; margin-bottom: 4px; }
.login-subtitle { color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 32px; }
.login-card {
  background: var(--white);
  border-radius: 16px;
  padding: 28px 24px;
  width: 100%;
  max-width: 340px;
  box-shadow: var(--shadow-md);
}
.login-card h3 { font-size: 1.1rem; margin-bottom: 16px; text-align: center; color: var(--gray-700); }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--gray-600); margin-bottom: 4px; }
.form-group input, .form-group select {
  width: 100%;
  padding: 12px 14px;
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-sm);
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s;
}
.form-group input:focus { border-color: var(--wa-teal); }
.phone-input-row { display: flex; gap: 8px; }
.phone-input-row select { width: 90px; flex-shrink: 0; }
.phone-input-row input { flex: 1; }
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 20px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
}
.btn-primary { background: var(--wa-dark); color: var(--white); }
.btn-primary:active { background: var(--wa-teal); }
.login-error { color: var(--danger); font-size: 0.82rem; text-align: center; margin-bottom: 12px; display: none; }
.login-loading { text-align: center; color: var(--gray-500); font-size: 0.85rem; padding: 8px; }

/* ===== Clinic Selector ===== */
.clinic-list { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
.clinic-option {
  padding: 14px 16px;
  border: 2px solid var(--gray-200);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}
.clinic-option:active { border-color: var(--wa-teal); background: #f0fdfa; }
.clinic-option-name { font-weight: 600; font-size: 1rem; }
.clinic-option-detail { font-size: 0.78rem; color: var(--gray-500); margin-top: 2px; }

/* ===== Cards ===== */
.card {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 10px;
  overflow: hidden;
}
.card-body { padding: 14px 16px; }
.card-clickable { cursor: pointer; transition: transform 0.1s; }
.card-clickable:active { transform: scale(0.98); }

/* ===== Badges ===== */
.badge {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.badge-paid { background: #dcfce7; color: #16a34a; }
.badge-pending { background: #fef3c7; color: #d97706; }
.badge-active { background: #dcfce7; color: #16a34a; }
.badge-completed { background: var(--gray-100); color: var(--gray-500); }
.badge-discontinued { background: #fef2f2; color: #dc2626; }
.badge-gpay, .badge-card { background: #dbeafe; color: #2563eb; }
.badge-cash { background: #dcfce7; color: #16a34a; }
.badge-campaign { background: #dbeafe; color: #2563eb; }
.badge-announcement { background: #fef3c7; color: #d97706; }

/* ===== Stat Cards ===== */
.stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.stat-card {
  background: var(--white);
  border-radius: var(--radius-sm);
  padding: 12px 10px;
  text-align: center;
  box-shadow: var(--shadow);
}
.stat-num { font-size: 1.5rem; font-weight: 800; color: var(--wa-dark); }
.stat-label { font-size: 0.68rem; color: var(--gray-500); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }

/* ===== Bills ===== */
.bill-card .bill-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.bill-card .bill-amount { font-size: 1.15rem; font-weight: 800; color: var(--gray-800); }
.bill-card .bill-desc { font-size: 0.85rem; color: var(--gray-600); margin-bottom: 2px; }
.bill-card .bill-date { font-size: 0.75rem; color: var(--gray-400); }

/* ===== Prescriptions ===== */
.rx-card .rx-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.rx-card .rx-med { font-size: 1rem; font-weight: 700; }
.rx-card .rx-detail { font-size: 0.82rem; color: var(--gray-600); line-height: 1.5; }
.rx-card .rx-detail span { display: inline-block; margin-right: 12px; }

/* ===== Chat Bubbles ===== */
.chat-container {
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><rect fill="%23E5DDD5" width="300" height="300"/><circle fill="%23ddd6cb" cx="50" cy="50" r="3" opacity="0.3"/><circle fill="%23ddd6cb" cx="150" cy="100" r="2" opacity="0.2"/><circle fill="%23ddd6cb" cx="250" cy="50" r="2.5" opacity="0.25"/><circle fill="%23ddd6cb" cx="100" cy="200" r="3" opacity="0.3"/><circle fill="%23ddd6cb" cx="200" cy="250" r="2" opacity="0.2"/></svg>') repeat;
  min-height: 200px;
  padding: 12px 8px;
  border-radius: var(--radius);
}
.chat-bubble {
  max-width: 85%;
  padding: 8px 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  position: relative;
  word-wrap: break-word;
}
.chat-bubble-received {
  background: var(--white);
  border-top-left-radius: 0;
  box-shadow: 0 1px 1px rgba(0,0,0,0.08);
}
.chat-bubble-sender { font-size: 0.72rem; font-weight: 700; color: var(--wa-teal); margin-bottom: 2px; }
.chat-bubble-text { font-size: 0.9rem; line-height: 1.45; }
.chat-bubble-time { font-size: 0.65rem; color: var(--gray-400); text-align: right; margin-top: 2px; }
.chat-bubble-type { display: inline-block; font-size: 0.6rem; font-weight: 700; text-transform: uppercase; padding: 1px 6px; border-radius: 4px; margin-bottom: 4px; }

/* ===== Review Tab ===== */
.review-section { text-align: center; }
.review-stars { font-size: 2rem; margin: 12px 0; }
.review-textarea {
  width: 100%;
  padding: 12px;
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-sm);
  font-size: 0.92rem;
  resize: vertical;
  min-height: 120px;
  outline: none;
}
.review-textarea:focus { border-color: var(--wa-teal); }
.btn-review {
  background: #4285F4;
  color: var(--white);
  padding: 14px 24px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  width: 100%;
  margin-top: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.btn-review:active { background: #3367d6; }

/* ===== Empty State ===== */
.empty-state {
  text-align: center;
  padding: 32px 16px;
  color: var(--gray-400);
}
.empty-state svg { width: 48px; height: 48px; margin-bottom: 8px; opacity: 0.4; }
.empty-state p { font-size: 0.88rem; }

/* ===== Appointments ===== */
.appt-card { display: flex; align-items: center; gap: 12px; }
.appt-date {
  background: var(--wa-dark);
  color: var(--white);
  border-radius: var(--radius-sm);
  text-align: center;
  padding: 6px 10px;
  min-width: 52px;
}
.appt-date-day { font-size: 1.3rem; font-weight: 800; line-height: 1; }
.appt-date-month { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
.appt-info { flex: 1; }
.appt-time { font-weight: 700; font-size: 0.95rem; }
.appt-type { font-size: 0.8rem; color: var(--gray-500); }

/* ===== Section Title ===== */
.section-title {
  font-size: 0.78rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--gray-500);
  margin: 16px 0 8px;
}

/* ===== Toast ===== */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--gray-800);
  color: var(--white);
  padding: 10px 20px;
  border-radius: 24px;
  font-size: 0.85rem;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}
.toast.show { opacity: 1; }

/* ===== Spinner ===== */
.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid var(--gray-200);
  border-top-color: var(--wa-teal);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== Detail overlay ===== */
.detail-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  display: flex;
  align-items: flex-end;
  justify-content: center;
}
.detail-sheet {
  background: var(--white);
  border-radius: 16px 16px 0 0;
  width: 100%;
  max-width: 480px;
  max-height: 70vh;
  overflow-y: auto;
  padding: 20px;
  animation: slideUp 0.25s ease-out;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.detail-sheet h3 { font-size: 1.1rem; margin-bottom: 12px; }
.detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-100); font-size: 0.88rem; }
.detail-row-label { color: var(--gray-500); font-weight: 500; }
.detail-row-value { font-weight: 600; text-align: right; max-width: 60%; }
.detail-close { text-align: center; margin-top: 16px; }
.detail-close button {
  background: var(--gray-100);
  border: none;
  padding: 10px 32px;
  border-radius: 24px;
  font-weight: 600;
  color: var(--gray-600);
  cursor: pointer;
}

/* ===== Review Suggestion Cards ===== */
.review-suggestions { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
.review-sug-card {
  padding: 12px 14px;
  border: 2px solid var(--gray-200);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
.review-sug-card:active { transform: scale(0.98); }
.review-sug-card.selected { border-color: var(--wa-teal); background: #f0fdfa; }
.review-sug-card .sug-label {
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--wa-teal);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.review-sug-card .sug-label .sug-icon { font-size: 0.9rem; }
.review-sug-card .sug-text { font-size: 0.85rem; color: var(--gray-700); line-height: 1.45; }
.review-sug-card .sug-check {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid var(--gray-300);
  display: flex;
  align-items: center;
  justify-content: center;
}
.review-sug-card.selected .sug-check {
  border-color: var(--wa-teal);
  background: var(--wa-teal);
  color: var(--white);
}
.review-or-divider {
  text-align: center;
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--gray-400);
  margin: 8px 0;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.review-custom-label {
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--gray-600);
  margin-bottom: 6px;
}
.daily-tip {
  background: linear-gradient(135deg, #f0fdfa 0%, #ecfdf5 100%);
  border-left: 3px solid var(--wa-teal);
  padding: 10px 14px;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  margin-bottom: 14px;
  font-size: 0.82rem;
  color: var(--gray-700);
}
.daily-tip strong { color: var(--wa-dark); }

/* ===== PWA Install Banner ===== */
.install-banner {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  background: var(--white);
  padding: 14px 16px;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
  z-index: 300;
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideUp 0.3s ease-out;
}
.install-banner-icon {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  flex-shrink: 0;
}
.install-banner-text { flex: 1; }
.install-banner-title { font-weight: 700; font-size: 0.92rem; color: var(--gray-800); }
.install-banner-desc { font-size: 0.75rem; color: var(--gray-500); margin-top: 1px; }
.install-banner-btn {
  background: var(--wa-dark);
  color: var(--white);
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.82rem;
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
}
.install-banner-btn:active { background: var(--wa-teal); }
.install-banner-close {
  position: absolute;
  top: 4px;
  right: 8px;
  background: none;
  border: none;
  font-size: 1.2rem;
  color: var(--gray-400);
  cursor: pointer;
  padding: 4px;
  line-height: 1;
}

/* ===== Exercise Progress Bar ===== */
.ex-progress {
  background: var(--white);
  border-radius: var(--radius);
  padding: 14px 16px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}
.ex-progress-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--gray-700);
}
.ex-progress-count {
  color: var(--wa-dark);
  font-weight: 800;
}
.ex-progress-bar {
  width: 100%;
  height: 8px;
  background: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
}
.ex-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--wa-teal), var(--wa-green));
  border-radius: 4px;
  transition: width 0.5s ease;
}

/* ===== Expandable Exercise Card ===== */
.ex-card {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 8px;
  overflow: hidden;
  transition: border-color 0.3s, background 0.3s;
  border: 2px solid transparent;
}
.ex-card.ex-done {
  background: #f0fdf4;
  border-color: #bbf7d0;
}
.ex-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.ex-card-thumb {
  flex-shrink: 0;
  width: 56px;
  height: 56px;
  background: var(--gray-100);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.ex-card-info {
  flex: 1;
  min-width: 0;
}
.ex-card-name {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--gray-800);
}
.ex-done .ex-card-name {
  color: var(--gray-400);
  text-decoration: line-through;
}
.ex-card-sets {
  font-size: 0.88rem;
  font-weight: 700;
  color: var(--wa-dark);
  margin-top: 2px;
}
.ex-done .ex-card-sets { color: var(--gray-400); }
.ex-card-right {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.ex-card-check {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--success);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--white);
  font-size: 0.9rem;
  font-weight: 700;
}
.ex-card-chevron {
  width: 20px;
  height: 20px;
  color: var(--gray-400);
  transition: transform 0.2s;
}
.ex-card-chevron.open { transform: rotate(180deg); }
.ex-card-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.ex-card-body.expanded {
  max-height: 600px;
}
.ex-card-body-inner {
  padding: 0 14px 14px;
  border-top: 1px solid var(--gray-100);
}
.ex-card-instructions {
  font-size: 0.85rem;
  color: var(--gray-600);
  line-height: 1.5;
  margin-top: 10px;
}
.ex-card-freq {
  font-size: 0.78rem;
  color: var(--gray-500);
  margin-top: 6px;
  font-weight: 500;
}
.ex-card-video {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.82rem;
  color: var(--wa-teal);
  font-weight: 600;
  margin-top: 8px;
  text-decoration: none;
}
.ex-complete-btn {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--wa-dark);
  color: var(--white);
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: background 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.ex-complete-btn:active { background: var(--wa-teal); }

/* Completion pulse animation */
@keyframes exDonePulse {
  0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.5); }
  70% { box-shadow: 0 0 0 12px rgba(34,197,94,0); }
  100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
}
.ex-card.ex-just-done {
  animation: exDonePulse 0.6s ease-out;
}

/* ===== Mic Button ===== */
.mic-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border: 2px dashed var(--gray-300);
  border-radius: var(--radius-sm);
  background: var(--gray-50);
  color: var(--gray-600);
  font-size: 0.88rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.mic-btn:active { background: var(--gray-100); }
.mic-btn.mic-active {
  border-color: var(--danger);
  background: #fef2f2;
  color: var(--danger);
}
.mic-btn svg { width: 20px; height: 20px; }
@keyframes micPulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.15); opacity: 0.7; }
}
.mic-btn.mic-active svg {
  animation: micPulse 1s ease-in-out infinite;
}

/* ===== Exercise Timer ===== */
.ex-timer-view {
  padding: 16px 0 8px;
  text-align: center;
}
.ex-timer-phase {
  font-size: 0.78rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--wa-teal);
  margin-bottom: 8px;
}
.ex-timer-set-counter {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--gray-600);
  margin-bottom: 12px;
}
.ex-timer-circle-wrap {
  position: relative;
  width: 140px;
  height: 140px;
  margin: 0 auto 12px;
}
.ex-timer-circle-wrap svg {
  width: 140px;
  height: 140px;
  transform: rotate(-90deg);
}
.ex-timer-circle-bg {
  fill: none;
  stroke: var(--gray-200);
  stroke-width: 6;
}
.ex-timer-circle-fg {
  fill: none;
  stroke: var(--wa-teal);
  stroke-width: 6;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.3s ease;
}
.ex-timer-circle-fg.rest {
  stroke: var(--warning);
}
.ex-timer-time {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.2rem;
  font-weight: 800;
  color: var(--gray-800);
}
.ex-timer-reps-prompt {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--gray-800);
  margin-bottom: 16px;
}
.ex-timer-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 14px 32px;
  border: none;
  border-radius: 28px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.ex-timer-btn-primary {
  background: var(--wa-dark);
  color: var(--white);
}
.ex-timer-btn-primary:active { background: var(--wa-teal); }
.ex-timer-btn-skip {
  background: none;
  border: none;
  color: var(--gray-400);
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 16px;
  margin-top: 8px;
}

/* ===== Pain Feedback Overlay ===== */
.pain-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 250;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.pain-sheet {
  background: var(--white);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 480px;
  padding: 24px 20px 32px;
  animation: slideUp 0.25s ease-out;
  text-align: center;
}
.pain-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--gray-800);
  margin-bottom: 4px;
}
.pain-subtitle {
  font-size: 0.82rem;
  color: var(--gray-500);
  margin-bottom: 20px;
}
.pain-emojis {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin-bottom: 16px;
}
.pain-emoji-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 14px 18px;
  border: 2px solid var(--gray-200);
  border-radius: 16px;
  background: var(--white);
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
  min-width: 90px;
}
.pain-emoji-btn:active { transform: scale(0.95); }
.pain-emoji-btn .emoji { font-size: 2rem; }
.pain-emoji-btn .label { font-size: 0.75rem; font-weight: 700; color: var(--gray-600); }
.pain-emoji-btn[data-pain="0"] { border-color: #bbf7d0; background: #f0fdf4; }
.pain-emoji-btn[data-pain="0"]:active { background: #dcfce7; }
.pain-emoji-btn[data-pain="1"] { border-color: #fef3c7; background: #fffbeb; }
.pain-emoji-btn[data-pain="1"]:active { background: #fef3c7; }
.pain-emoji-btn[data-pain="2"] { border-color: #fecaca; background: #fef2f2; }
.pain-emoji-btn[data-pain="2"]:active { background: #fee2e2; }
.pain-skip {
  color: var(--gray-400);
  font-size: 0.82rem;
  font-weight: 600;
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px 16px;
}
</style>
</head>
<body>
<div id="app"></div>
<div id="toast" class="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<script>
(function() {
'use strict';

// ===== Firebase Config =====
var firebaseConfig = {
  apiKey: "AIzaSyBcaymsJYlDpQ-EPF2Wtd-nYX2P6u7HQoE",
  authDomain: "physio-clinic-4ae53.firebaseapp.com",
  projectId: "physio-clinic-4ae53",
  storageBucket: "physio-clinic-4ae53.firebasestorage.app",
  messagingSenderId: "791291492733",
  appId: "1:791291492733:web:9edaccf13df450b5513414"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

// ===== Speech API Detection =====
var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
var _speechSupported = !!SpeechRecognition;

// ===== State =====
var state = {
  screen: 'loading', // loading | login | clinicSelect | app
  tab: 'home',
  phone: localStorage.getItem('mobi_phone') || '',
  phoneCode: localStorage.getItem('mobi_phoneCode') || '+91',
  clinicId: localStorage.getItem('mobi_clinicId') || '',
  patientId: localStorage.getItem('mobi_patientId') || '',
  patientName: localStorage.getItem('mobi_patientName') || '',
  clinicName: localStorage.getItem('mobi_clinicName') || '',
  clinics: [],
  // Data
  appointments: [],
  bills: [],
  prescriptions: [],
  messages: [],
  sessions: [],
  exercises: [],
  exerciseLog: {},
  patientTags: [],
  patientDiagnosis: '',
  patientDoc: null,
  clinicDoc: null,
  // UI
  detailItem: null,
  detailType: null,
  lastReadTimestamp: localStorage.getItem('mobi_lastRead') || '',
  dataLoaded: false,
  _unsubClinic: null,
  _unsubExercises: null,
  _unsubExerciseLog: null,
  _expandedExIdx: null,
  _micListening: false,
  _micSupported: false,
  _activeExTimer: null // { exIdx, currentSet, totalSets, phase, timeLeft, timerInterval }
};

// ===== Feature Toggle Helper =====
// Checks mobileFeatures first, falls back to web features, defaults to true
// Also falls back to localStorage clinic settings (for local/offline use)
function isMobileFeatureOn(key) {
  var doc = state.clinicDoc || {};
  // If clinicDoc is empty (no Firestore), try localStorage
  if (!doc.features && !doc.mobileFeatures) {
    var cid = state.clinicId || localStorage.getItem('mobi_clinicId') || 'default';
    try {
      var raw = localStorage.getItem('physio_clinic_' + cid);
      // If clinic-specific key not found, try 'default'
      if (!raw && cid !== 'default') raw = localStorage.getItem('physio_clinic_default');
      doc = JSON.parse(raw || '{}');
    } catch(e) {}
  }
  var mobile = doc.mobileFeatures || {};
  if (mobile[key] !== undefined) return mobile[key] !== false;
  var web = doc.features || {};
  if (web[key] !== undefined) return web[key] !== false;
  return true;
}

// ===== Helpers =====
function normalizePhone(phone, phoneCode) {
  var digits = (phone || '').replace(/\D/g, '');
  if (!digits) return '';
  var code = (phoneCode || '+91').replace('+', '');
  if (digits.length > 10 && digits.indexOf(code) === 0) return digits;
  if (digits.length === 10) return code + digits;
  return digits;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  var parts = dateStr.split('-');
  if (parts.length !== 3) return dateStr;
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return parseInt(parts[2],10) + ' ' + months[parseInt(parts[1],10) - 1] + ' ' + parts[0];
}

function formatTime(timeStr) {
  if (!timeStr) return '';
  var parts = timeStr.split(':');
  var h = parseInt(parts[0],10);
  var m = parts[1] || '00';
  var ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return h + ':' + m + ' ' + ampm;
}

function formatCurrency(amount) {
  var num = parseFloat(amount);
  if (isNaN(num)) return amount;
  return '\u20B9' + num.toLocaleString('en-IN');
}

function timeAgo(dateStr) {
  if (!dateStr) return '';
  var d = new Date(dateStr);
  var now = new Date();
  var diff = now - d;
  var mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  var hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  var days = Math.floor(hrs / 24);
  if (days < 7) return days + 'd ago';
  return formatDate(dateStr.split('T')[0]);
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2500);
}

function todayStr() {
  var d = new Date();
  return d.getFullYear() + '-' + ('0' + (d.getMonth()+1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
}

// ===== Inline Exercise Library =====
var ExLib = (function() {
  var _gender = 'neutral';
  function setGender(g) { _gender = g || 'neutral'; }
  function getGender() { return _gender; }

  function drawLimb(x1, y1, x2, y2, w1, w2, fill) {
    var dx = x2 - x1, dy = y2 - y1;
    var len = Math.sqrt(dx * dx + dy * dy) || 1;
    var nx = -dy / len, ny = dx / len;
    var p1x = x1 + nx * w1, p1y = y1 + ny * w1;
    var p2x = x1 - nx * w1, p2y = y1 - ny * w1;
    var p3x = x2 - nx * w2, p3y = y2 - ny * w2;
    var p4x = x2 + nx * w2, p4y = y2 + ny * w2;
    var mx1 = (p1x + p4x) / 2, my1 = (p1y + p4y) / 2;
    var mx2 = (p2x + p3x) / 2, my2 = (p2y + p3y) / 2;
    return '<path d="M' + r(p1x) + ',' + r(p1y) +
      ' Q' + r(mx1 + nx * 0.5) + ',' + r(my1 + ny * 0.5) + ' ' + r(p4x) + ',' + r(p4y) +
      ' Q' + r(x2 + nx * w2 * 0.3) + ',' + r(y2 + ny * w2 * 0.3) + ' ' + r(p3x) + ',' + r(p3y) +
      ' Q' + r(mx2 - nx * 0.5) + ',' + r(my2 - ny * 0.5) + ' ' + r(p2x) + ',' + r(p2y) +
      ' Q' + r(x1 - nx * w1 * 0.3) + ',' + r(y1 - ny * w1 * 0.3) + ' ' + r(p1x) + ',' + r(p1y) +
      'Z" fill="' + fill + '"/>';
  }

  function r(n) { return Math.round(n * 10) / 10; }

  function drawFigure(pose, highlight, props, markerId) {
    var hl = highlight || [];
    var p = props || {};
    var isFemale = _gender === 'female';
    var isMale = _gender === 'male';
    var bodyFill = isFemale ? '#475569' : (isMale ? '#334155' : '#64748b');
    var bodyFillLight = isFemale ? '#64748b' : (isMale ? '#475569' : '#94a3b8');
    var hlFill = '#059669';
    var hlFillLight = '#34d399';
    var mid = markerId || 'arrowhead';
    var gradId = mid + '_g';
    var hlGradId = mid + '_hg';
    var bgGradId = mid + '_bg';
    var shadowGradId = mid + '_sg';

    function isHl(part) {
      for (var i = 0; i < hl.length; i++) { if (hl[i] === part) return true; }
      return false;
    }
    function fc(part) { return isHl(part) ? 'url(#' + hlGradId + ')' : 'url(#' + gradId + ')'; }

    var neckX = pose.headX, neckY = pose.headY + 6;
    var svg = '';

    svg += '<defs>';
    svg += '<linearGradient id="' + gradId + '" x1="0" y1="0" x2="0" y2="1">';
    svg += '<stop offset="0%" stop-color="' + bodyFillLight + '"/>';
    svg += '<stop offset="100%" stop-color="' + bodyFill + '"/>';
    svg += '</linearGradient>';
    svg += '<linearGradient id="' + hlGradId + '" x1="0" y1="0" x2="0" y2="1">';
    svg += '<stop offset="0%" stop-color="#34d399"/>';
    svg += '<stop offset="100%" stop-color="#059669"/>';
    svg += '</linearGradient>';
    svg += '<radialGradient id="' + bgGradId + '">';
    svg += '<stop offset="0%" stop-color="#ccfbf1" stop-opacity="0.5"/>';
    svg += '<stop offset="100%" stop-color="#ccfbf1" stop-opacity="0"/>';
    svg += '</radialGradient>';
    svg += '<radialGradient id="' + shadowGradId + '">';
    svg += '<stop offset="0%" stop-color="rgba(0,0,0,0.12)"/>';
    svg += '<stop offset="100%" stop-color="rgba(0,0,0,0)"/>';
    svg += '</radialGradient>';
    svg += '</defs>';

    var shoulderW = isFemale ? 4.2 : (isMale ? 7.2 : 5.8);
    var hipW = isFemale ? 5 : (isMale ? 3.8 : 4.2);
    var headRx = isFemale ? 5.2 : (isMale ? 6.2 : 5.7);
    var headRy = isFemale ? 6 : (isMale ? 5.4 : 5.7);
    var armW1 = isFemale ? 2 : (isMale ? 3.8 : 3);
    var armW2 = isFemale ? 1.4 : (isMale ? 2.8 : 2.2);
    var legW1 = isFemale ? 3 : (isMale ? 4.2 : 3.5);
    var legW2 = isFemale ? 2 : (isMale ? 3 : 2.4);
    var calfW1 = isFemale ? 2.2 : (isMale ? 3.4 : 2.7);
    var calfW2 = isFemale ? 1.5 : (isMale ? 2.4 : 2);
    var neckW = isFemale ? 1.6 : (isMale ? 3.2 : 2.2);
    var jointR = isFemale ? 1.2 : (isMale ? 2 : 1.6);

    var cx = r((pose.headX + pose.hipX) / 2);
    var cy = r((pose.headY + pose.hipY) / 2);
    svg += '<circle cx="' + cx + '" cy="' + cy + '" r="45" fill="url(#' + bgGradId + ')"/>';

    if (p.mat) {
      svg += '<rect x="' + p.mat[0] + '" y="' + p.mat[1] + '" width="' + p.mat[2] + '" height="' + p.mat[3] + '" rx="2" fill="#e2e8f0"/>';
    }
    if (p.surface) {
      svg += '<rect x="' + p.surface[0] + '" y="' + (p.surface[1] - 1) + '" width="' + (p.surface[2] - p.surface[0]) + '" height="3" rx="1.5" fill="#e2e8f0"/>';
    }
    if (p.wall) {
      svg += '<rect x="' + p.wall[0] + '" y="' + p.wall[1] + '" width="4" height="' + (p.wall[3] - p.wall[1]) + '" rx="1.5" fill="#cbd5e1"/>';
    }
    if (p.chair) {
      svg += '<polyline points="' + p.chair + '" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
    }

    var shadowY = p.surface ? p.surface[1] : (p.mat ? p.mat[1] : 115);
    svg += '<ellipse cx="' + r((pose.headX + pose.hipX) / 2) + '" cy="' + r(shadowY) + '" rx="20" ry="3" fill="url(#' + shadowGradId + ')"/>';

    svg += drawLimb(pose.hipX - 1, pose.hipY, pose.lKnee[0], pose.lKnee[1], legW1, calfW1, fc('lLeg'));
    svg += drawLimb(pose.lKnee[0], pose.lKnee[1], pose.lFoot[0], pose.lFoot[1], calfW1, calfW2, fc('lLeg'));
    svg += '<ellipse cx="' + r(pose.lFoot[0]) + '" cy="' + r(pose.lFoot[1]) + '" rx="' + (calfW2 + 0.5) + '" ry="' + (calfW2) + '" fill="' + fc('lLeg') + '"/>';
    svg += '<circle cx="' + r(pose.lKnee[0]) + '" cy="' + r(pose.lKnee[1]) + '" r="' + jointR + '" fill="' + fc('lLeg') + '" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>';

    svg += drawLimb(pose.hipX + 1, pose.hipY, pose.rKnee[0], pose.rKnee[1], legW1, calfW1, fc('rLeg'));
    svg += drawLimb(pose.rKnee[0], pose.rKnee[1], pose.rFoot[0], pose.rFoot[1], calfW1, calfW2, fc('rLeg'));
    svg += '<ellipse cx="' + r(pose.rFoot[0]) + '" cy="' + r(pose.rFoot[1]) + '" rx="' + (calfW2 + 0.5) + '" ry="' + (calfW2) + '" fill="' + fc('rLeg') + '"/>';
    svg += '<circle cx="' + r(pose.rKnee[0]) + '" cy="' + r(pose.rKnee[1]) + '" r="' + jointR + '" fill="' + fc('rLeg') + '" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>';

    svg += drawLimb(neckX - 2, neckY + 2, pose.lElbow[0], pose.lElbow[1], armW1, armW2, fc('lArm'));
    svg += drawLimb(pose.lElbow[0], pose.lElbow[1], pose.lHand[0], pose.lHand[1], armW2, armW2 * 0.7, fc('lArm'));
    svg += '<circle cx="' + r(pose.lHand[0]) + '" cy="' + r(pose.lHand[1]) + '" r="' + (armW2 * 0.8) + '" fill="' + fc('lArm') + '"/>';
    svg += '<circle cx="' + r(pose.lElbow[0]) + '" cy="' + r(pose.lElbow[1]) + '" r="' + (jointR * 0.8) + '" fill="' + fc('lArm') + '" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>';

    var tDx = pose.hipX - neckX, tDy = pose.hipY - neckY;
    var tLen = Math.sqrt(tDx * tDx + tDy * tDy) || 1;
    var tNx = -tDy / tLen, tNy = tDx / tLen;
    svg += '<path d="M' + r(neckX + tNx * shoulderW) + ',' + r(neckY + tNy * shoulderW) +
      ' Q' + r(neckX + tNx * (shoulderW + 1)) + ',' + r(neckY + (pose.hipY - neckY) * 0.3) +
      ' ' + r(pose.hipX + tNx * hipW) + ',' + r(pose.hipY + tNy * hipW) +
      ' Q' + r(pose.hipX) + ',' + r(pose.hipY + hipW * 0.5) +
      ' ' + r(pose.hipX - tNx * hipW) + ',' + r(pose.hipY - tNy * hipW) +
      ' Q' + r(neckX - tNx * (shoulderW + 1)) + ',' + r(neckY + (pose.hipY - neckY) * 0.3) +
      ' ' + r(neckX - tNx * shoulderW) + ',' + r(neckY - tNy * shoulderW) +
      'Z" fill="url(#' + gradId + ')"/>';

    svg += drawLimb(neckX + 2, neckY + 2, pose.rElbow[0], pose.rElbow[1], armW1, armW2, fc('rArm'));
    svg += drawLimb(pose.rElbow[0], pose.rElbow[1], pose.rHand[0], pose.rHand[1], armW2, armW2 * 0.7, fc('rArm'));
    svg += '<circle cx="' + r(pose.rHand[0]) + '" cy="' + r(pose.rHand[1]) + '" r="' + (armW2 * 0.8) + '" fill="' + fc('rArm') + '"/>';
    svg += '<circle cx="' + r(pose.rElbow[0]) + '" cy="' + r(pose.rElbow[1]) + '" r="' + (jointR * 0.8) + '" fill="' + fc('rArm') + '" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>';

    svg += '<rect x="' + r(neckX - neckW) + '" y="' + r(neckY - 1) + '" width="' + r(neckW * 2) + '" height="4" rx="' + r(neckW) + '" fill="url(#' + gradId + ')"/>';

    svg += '<ellipse cx="' + pose.headX + '" cy="' + pose.headY + '" rx="' + headRx + '" ry="' + headRy + '" fill="url(#' + gradId + ')"/>';
    svg += '<circle cx="' + r(pose.headX - 2) + '" cy="' + r(pose.headY - 0.5) + '" r="0.7" fill="rgba(255,255,255,0.6)"/>';
    svg += '<circle cx="' + r(pose.headX + 2) + '" cy="' + r(pose.headY - 0.5) + '" r="0.7" fill="rgba(255,255,255,0.6)"/>';
    svg += '<path d="M' + r(pose.headX - 1.5) + ',' + r(pose.headY + 1.5) + ' Q' + r(pose.headX) + ',' + r(pose.headY + 2.8) + ' ' + r(pose.headX + 1.5) + ',' + r(pose.headY + 1.5) + '" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="0.5" stroke-linecap="round"/>';
    if (isMale) {
      var _ht = pose.headY - headRy;
      svg += '<path d="M' + r(pose.headX + headRx) + ',' + r(pose.headY - 1) + ' Q' + r(pose.headX + headRx + 1) + ',' + r(_ht - 1) + ' ' + r(pose.headX - 1) + ',' + r(_ht - 3) + ' Q' + r(pose.headX - headRx - 1) + ',' + r(_ht - 1) + ' ' + r(pose.headX - headRx) + ',' + r(pose.headY - 2) + '" fill="' + bodyFill + '"/>';
    }
    if (isFemale) {
      svg += '<path d="M' + r(pose.headX - headRx - 1) + ',' + r(pose.headY + 1) + ' Q' + r(pose.headX - headRx - 2) + ',' + r(pose.headY - headRy) + ' ' + r(pose.headX) + ',' + r(pose.headY - headRy - 2) + ' Q' + r(pose.headX + headRx + 2) + ',' + r(pose.headY - headRy) + ' ' + r(pose.headX + headRx + 1) + ',' + r(pose.headY + 1) + '" fill="' + bodyFill + '"/>';
      svg += '<path d="M' + r(pose.headX - headRx - 1) + ',' + r(pose.headY + 1) + ' L' + r(pose.headX - headRx) + ',' + r(pose.headY + headRy - 1) + '" stroke="' + bodyFill + '" stroke-width="2" stroke-linecap="round" fill="none"/>';
      svg += '<path d="M' + r(pose.headX + headRx + 1) + ',' + r(pose.headY + 1) + ' L' + r(pose.headX + headRx) + ',' + r(pose.headY + headRy - 1) + '" stroke="' + bodyFill + '" stroke-width="2" stroke-linecap="round" fill="none"/>';
    }

    if (p.arrow) {
      svg += '<polyline points="' + p.arrow + '" fill="none" stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" marker-end="url(#' + mid + ')"/>';
    }

    return svg;
  }

  var exercises = [
    {id:'straight_leg_raise',name:'Straight Leg Raise',bodyPart:'knee',frame1:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[60,55],lFoot:[70,75],rKnee:[60,55],rFoot:[70,75],hl:['rLeg'],props:{mat:[10,38,80,4]}},frame2:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[60,55],lFoot:[70,75],rKnee:[68,25],rFoot:[85,18],hl:['rLeg'],props:{mat:[10,38,80,4],arrow:'80,30 85,20'}}},
    {id:'knee_bend_sitting',name:'Knee Bend (Sitting)',bodyPart:'knee',frame1:{headX:40,headY:15,hipX:40,hipY:55,lElbow:[30,45],lHand:[25,55],rElbow:[50,45],rHand:[55,55],lKnee:[30,75],lFoot:[30,95],rKnee:[50,75],rFoot:[50,95],hl:['rLeg'],props:{chair:'25,50 25,95 60,95 60,50',surface:[10,100,90,100]}},frame2:{headX:40,headY:15,hipX:40,hipY:55,lElbow:[30,45],lHand:[25,55],rElbow:[50,45],rHand:[55,55],lKnee:[30,75],lFoot:[30,95],rKnee:[55,70],rFoot:[68,72],hl:['rLeg'],props:{chair:'25,50 25,95 60,95 60,50',surface:[10,100,90,100],arrow:'62,78 68,72'}}},
    {id:'wall_squat',name:'Wall Slide Squat',bodyPart:'knee',frame1:{headX:55,headY:12,hipX:55,hipY:48,lElbow:[45,35],lHand:[40,45],rElbow:[65,35],rHand:[70,45],lKnee:[45,72],lFoot:[42,95],rKnee:[65,72],rFoot:[68,95],hl:['lLeg','rLeg'],props:{wall:[75,0,75,100],surface:[10,100,90,100]}},frame2:{headX:55,headY:28,hipX:55,hipY:62,lElbow:[45,48],lHand:[40,58],rElbow:[65,48],rHand:[70,58],lKnee:[40,78],lFoot:[38,95],rKnee:[70,78],rFoot:[72,95],hl:['lLeg','rLeg'],props:{wall:[75,0,75,100],surface:[10,100,90,100],arrow:'55,45 55,58'}}},
    {id:'quad_stretch_standing',name:'Quad Stretch (Standing)',bodyPart:'knee',frame1:{headX:45,headY:10,hipX:45,hipY:48,lElbow:[35,35],lHand:[30,45],rElbow:[55,35],rHand:[60,45],lKnee:[40,72],lFoot:[38,95],rKnee:[50,72],rFoot:[52,95],hl:['rLeg'],props:{surface:[10,100,90,100]}},frame2:{headX:45,headY:10,hipX:45,hipY:48,lElbow:[35,35],lHand:[30,45],rElbow:[55,50],rHand:[58,62],lKnee:[40,72],lFoot:[38,95],rKnee:[55,62],rFoot:[58,50],hl:['rLeg'],props:{surface:[10,100,90,100],arrow:'56,58 58,50'}}},
    {id:'hamstring_stretch',name:'Hamstring Stretch (Sitting)',bodyPart:'knee',frame1:{headX:30,headY:25,hipX:42,hipY:50,lElbow:[25,40],lHand:[20,50],rElbow:[45,38],rHand:[50,45],lKnee:[55,55],lFoot:[75,52],rKnee:[35,70],rFoot:[30,90],hl:['lLeg'],props:{mat:[10,55,80,4]}},frame2:{headX:38,headY:22,hipX:42,hipY:50,lElbow:[50,35],lHand:[60,40],rElbow:[52,38],rHand:[58,42],lKnee:[55,55],lFoot:[75,52],rKnee:[35,70],rFoot:[30,90],hl:['lLeg'],props:{mat:[10,55,80,4],arrow:'55,38 62,40'}}},
    {id:'heel_slide',name:'Heel Slide',bodyPart:'knee',frame1:{headX:20,headY:30,hipX:42,hipY:38,lElbow:[28,28],lHand:[30,22],rElbow:[50,30],rHand:[55,24],lKnee:[55,50],lFoot:[72,40],rKnee:[55,50],rFoot:[72,40],hl:['rLeg'],props:{mat:[5,42,90,4]}},frame2:{headX:20,headY:30,hipX:42,hipY:38,lElbow:[28,28],lHand:[30,22],rElbow:[50,30],rHand:[55,24],lKnee:[55,50],lFoot:[72,40],rKnee:[50,28],rFoot:[52,38],hl:['rLeg'],props:{mat:[5,42,90,4],arrow:'60,42 52,38'}}},
    {id:'step_up',name:'Step Up',bodyPart:'knee',frame1:{headX:45,headY:8,hipX:45,hipY:45,lElbow:[35,30],lHand:[30,40],rElbow:[55,30],rHand:[60,40],lKnee:[38,68],lFoot:[35,90],rKnee:[52,58],rFoot:[55,68],hl:['rLeg'],props:{surface:[20,72,80,72]}},frame2:{headX:55,headY:2,hipX:55,hipY:38,lElbow:[45,25],lHand:[40,35],rElbow:[65,25],rHand:[70,35],lKnee:[48,55],lFoot:[45,68],rKnee:[62,55],rFoot:[65,68],hl:['rLeg'],props:{surface:[20,72,80,72],arrow:'55,48 55,38'}}},
    {id:'calf_raise',name:'Calf Raise',bodyPart:'knee',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[40,35],lHand:[35,45],rElbow:[60,35],rHand:[65,45],lKnee:[45,72],lFoot:[43,95],rKnee:[55,72],rFoot:[57,95],hl:['lLeg','rLeg'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:5,hipX:50,hipY:43,lElbow:[40,30],lHand:[35,40],rElbow:[60,30],rHand:[65,40],lKnee:[45,66],lFoot:[43,85],rKnee:[55,66],rFoot:[57,85],hl:['lLeg','rLeg'],props:{surface:[15,100,85,100],arrow:'50,50 50,40'}}},
    {id:'terminal_knee_ext',name:'Terminal Knee Extension',bodyPart:'knee',frame1:{headX:25,headY:28,hipX:45,hipY:36,lElbow:[30,25],lHand:[32,18],rElbow:[52,28],rHand:[58,22],lKnee:[58,48],lFoot:[72,60],rKnee:[55,50],rFoot:[68,62],hl:['rLeg'],props:{mat:[8,40,85,4]}},frame2:{headX:25,headY:28,hipX:45,hipY:36,lElbow:[30,25],lHand:[32,18],rElbow:[52,28],rHand:[58,22],lKnee:[58,48],lFoot:[72,60],rKnee:[62,38],rFoot:[80,36],hl:['rLeg'],props:{mat:[8,40,85,4],arrow:'72,42 80,36'}}},
    {id:'knee_to_chest',name:'Knee to Chest',bodyPart:'knee',frame1:{headX:20,headY:30,hipX:42,hipY:38,lElbow:[30,28],lHand:[35,22],rElbow:[50,30],rHand:[55,24],lKnee:[55,50],lFoot:[72,42],rKnee:[55,50],rFoot:[72,42],hl:['rLeg'],props:{mat:[5,42,90,4]}},frame2:{headX:20,headY:30,hipX:42,hipY:38,lElbow:[38,22],lHand:[42,28],rElbow:[50,24],rHand:[48,30],lKnee:[55,50],lFoot:[72,42],rKnee:[42,22],rFoot:[35,28],hl:['rLeg'],props:{mat:[5,42,90,4],arrow:'48,28 42,22'}}},
    {id:'pendulum_swing',name:'Pendulum Swing',bodyPart:'shoulder',frame1:{headX:45,headY:10,hipX:48,hipY:48,lElbow:[30,45],lHand:[20,60],rElbow:[58,35],rHand:[65,25],lKnee:[42,72],lFoot:[38,95],rKnee:[55,72],rFoot:[58,95],hl:['lArm'],props:{surface:[10,100,90,100]}},frame2:{headX:45,headY:10,hipX:48,hipY:48,lElbow:[32,50],lHand:[30,70],rElbow:[58,35],rHand:[65,25],lKnee:[42,72],lFoot:[38,95],rKnee:[55,72],rFoot:[58,95],hl:['lArm'],props:{surface:[10,100,90,100],arrow:'22,55 30,68'}}},
    {id:'wall_crawl',name:'Wall Crawl (Finger Walk)',bodyPart:'shoulder',frame1:{headX:40,headY:10,hipX:40,hipY:48,lElbow:[30,35],lHand:[25,45],rElbow:[55,25],rHand:[68,30],lKnee:[35,72],lFoot:[32,95],rKnee:[48,72],rFoot:[50,95],hl:['rArm'],props:{wall:[72,0,72,100],surface:[10,100,90,100]}},frame2:{headX:40,headY:10,hipX:40,hipY:48,lElbow:[30,35],lHand:[25,45],rElbow:[60,10],rHand:[68,5],lKnee:[35,72],lFoot:[32,95],rKnee:[48,72],rFoot:[50,95],hl:['rArm'],props:{wall:[72,0,72,100],surface:[10,100,90,100],arrow:'68,25 68,8'}}},
    {id:'shoulder_ext_rotation',name:'External Rotation',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,35],rHand:[62,48],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,35],rHand:[78,35],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100],arrow:'68,42 78,35'}}},
    {id:'shoulder_int_rotation',name:'Internal Rotation',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,35],rHand:[78,35],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,35],rHand:[62,48],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100],arrow:'75,35 65,46'}}},
    {id:'shoulder_shrug',name:'Shoulder Shrug',bodyPart:'shoulder',frame1:{headX:50,headY:12,hipX:50,hipY:50,lElbow:[38,38],lHand:[32,52],rElbow:[62,38],rHand:[68,52],lKnee:[44,74],lFoot:[42,95],rKnee:[56,74],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:12,hipX:50,hipY:50,lElbow:[36,32],lHand:[30,45],rElbow:[64,32],rHand:[70,45],lKnee:[44,74],lFoot:[42,95],rKnee:[56,74],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100],arrow:'38,40 36,32'}}},
    {id:'cross_body_stretch',name:'Cross Body Stretch',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[60,32],rHand:[65,35],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,30],lHand:[42,35],rElbow:[45,32],rHand:[30,32],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100],arrow:'38,32 30,32'}}},
    {id:'arm_raise_front',name:'Front Arm Raise',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,48],rElbow:[62,35],rHand:[70,48],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,48],rElbow:[62,15],rHand:[68,2],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100],arrow:'68,12 68,4'}}},
    {id:'arm_raise_side',name:'Side Arm Raise',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,48],rElbow:[62,35],rHand:[70,48],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,48],rElbow:[75,15],rHand:[88,8],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100],arrow:'82,12 88,8'}}},
    {id:'towel_stretch_shoulder',name:'Towel Stretch (Behind Back)',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[35,25],lHand:[30,12],rElbow:[60,55],rHand:[58,65],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[33,20],lHand:[28,8],rElbow:[58,52],rHand:[55,58],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100],arrow:'30,15 28,8'}}},
    {id:'wall_pushup',name:'Wall Push-Up',bodyPart:'shoulder',frame1:{headX:40,headY:12,hipX:48,hipY:50,lElbow:[28,25],lHand:[20,20],rElbow:[48,22],rHand:[20,18],lKnee:[52,75],lFoot:[58,95],rKnee:[58,75],rFoot:[64,95],hl:['lArm','rArm'],props:{wall:[18,0,18,100],surface:[15,100,85,100]}},frame2:{headX:30,headY:12,hipX:42,hipY:50,lElbow:[22,28],lHand:[18,20],rElbow:[35,25],rHand:[18,18],lKnee:[50,75],lFoot:[58,95],rKnee:[55,75],rFoot:[64,95],hl:['lArm','rArm'],props:{wall:[18,0,18,100],surface:[15,100,85,100],arrow:'34,14 28,14'}}},
    {id:'cat_cow',name:'Cat-Cow Stretch',bodyPart:'back',frame1:{headX:22,headY:30,hipX:65,hipY:32,lElbow:[18,55],lHand:[18,72],rElbow:[30,55],rHand:[30,72],lKnee:[58,55],lFoot:[58,72],rKnee:[72,55],rFoot:[72,72],hl:[],props:{mat:[5,75,80,4]}},frame2:{headX:22,headY:38,hipX:65,hipY:38,lElbow:[18,58],lHand:[18,72],rElbow:[30,58],rHand:[30,72],lKnee:[58,58],lFoot:[58,72],rKnee:[72,58],rFoot:[72,72],hl:[],props:{mat:[5,75,80,4],arrow:'44,28 44,38'}}},
    {id:'bird_dog',name:'Bird Dog',bodyPart:'back',frame1:{headX:22,headY:32,hipX:65,hipY:35,lElbow:[18,55],lHand:[18,72],rElbow:[30,55],rHand:[30,72],lKnee:[58,55],lFoot:[58,72],rKnee:[72,55],rFoot:[72,72],hl:[],props:{mat:[5,75,80,4]}},frame2:{headX:18,headY:30,hipX:65,hipY:35,lElbow:[10,32],lHand:[2,30],rElbow:[30,55],rHand:[30,72],lKnee:[58,55],lFoot:[58,72],rKnee:[78,30],rFoot:[90,28],hl:['lArm','rLeg'],props:{mat:[5,75,80,4],arrow:'5,32 2,30'}}},
    {id:'pelvic_tilt',name:'Pelvic Tilt',bodyPart:'back',frame1:{headX:18,headY:35,hipX:45,hipY:40,lElbow:[25,32],lHand:[30,28],rElbow:[52,35],rHand:[58,30],lKnee:[55,22],lFoot:[62,40],rKnee:[58,24],rFoot:[65,42],hl:[],props:{mat:[5,45,85,4]}},frame2:{headX:18,headY:35,hipX:45,hipY:38,lElbow:[25,32],lHand:[30,28],rElbow:[52,33],rHand:[58,28],lKnee:[55,22],lFoot:[62,40],rKnee:[58,24],rFoot:[65,42],hl:[],props:{mat:[5,45,85,4],arrow:'45,44 45,38'}}},
    {id:'bridge',name:'Glute Bridge',bodyPart:'back',frame1:{headX:15,headY:40,hipX:42,hipY:42,lElbow:[22,38],lHand:[28,35],rElbow:[50,38],rHand:[56,35],lKnee:[55,24],lFoot:[62,42],rKnee:[58,26],rFoot:[65,44],hl:['lLeg','rLeg'],props:{mat:[5,48,85,4]}},frame2:{headX:15,headY:40,hipX:42,hipY:28,lElbow:[22,38],lHand:[28,35],rElbow:[50,32],rHand:[56,28],lKnee:[55,22],lFoot:[62,42],rKnee:[58,24],rFoot:[65,44],hl:['lLeg','rLeg'],props:{mat:[5,48,85,4],arrow:'42,40 42,28'}}},
    {id:'child_pose',name:'Child\'s Pose',bodyPart:'back',frame1:{headX:25,headY:35,hipX:60,hipY:38,lElbow:[20,55],lHand:[18,68],rElbow:[35,55],rHand:[32,68],lKnee:[55,55],lFoot:[55,68],rKnee:[68,55],rFoot:[68,68],hl:[],props:{mat:[5,72,80,4]}},frame2:{headX:18,headY:42,hipX:60,hipY:42,lElbow:[12,55],lHand:[5,50],rElbow:[22,55],rHand:[10,48],lKnee:[55,58],lFoot:[55,68],rKnee:[68,58],rFoot:[68,68],hl:[],props:{mat:[5,72,80,4],arrow:'12,48 5,50'}}},
    {id:'trunk_rotation',name:'Trunk Rotation (Lying)',bodyPart:'back',frame1:{headX:18,headY:32,hipX:45,hipY:38,lElbow:[28,22],lHand:[35,15],rElbow:[52,25],rHand:[60,18],lKnee:[55,22],lFoot:[60,38],rKnee:[58,24],rFoot:[62,40],hl:['lLeg','rLeg'],props:{mat:[5,42,85,4]}},frame2:{headX:18,headY:32,hipX:45,hipY:38,lElbow:[28,22],lHand:[35,15],rElbow:[52,25],rHand:[60,18],lKnee:[50,18],lFoot:[40,20],rKnee:[52,20],rFoot:[42,22],hl:['lLeg','rLeg'],props:{mat:[5,42,85,4],arrow:'48,22 42,22'}}},
    {id:'prone_extension',name:'Prone Back Extension',bodyPart:'back',frame1:{headX:25,headY:38,hipX:65,hipY:42,lElbow:[20,48],lHand:[20,58],rElbow:[35,48],rHand:[35,58],lKnee:[75,48],lFoot:[88,42],rKnee:[78,50],rFoot:[90,44],hl:[],props:{mat:[5,52,90,4]}},frame2:{headX:22,headY:25,hipX:65,hipY:42,lElbow:[18,38],lHand:[18,48],rElbow:[32,38],rHand:[32,48],lKnee:[75,48],lFoot:[88,42],rKnee:[78,50],rFoot:[90,44],hl:[],props:{mat:[5,52,90,4],arrow:'25,32 22,25'}}},
    {id:'dead_bug',name:'Dead Bug',bodyPart:'back',frame1:{headX:18,headY:40,hipX:45,hipY:38,lElbow:[28,28],lHand:[22,20],rElbow:[52,28],rHand:[48,18],lKnee:[52,22],lFoot:[48,15],rKnee:[58,22],rFoot:[55,14],hl:['rArm','lLeg'],props:{mat:[5,45,85,4]}},frame2:{headX:18,headY:40,hipX:45,hipY:38,lElbow:[28,28],lHand:[22,20],rElbow:[55,22],rHand:[62,15],lKnee:[58,30],lFoot:[68,38],rKnee:[58,22],rFoot:[55,14],hl:['rArm','lLeg'],props:{mat:[5,45,85,4],arrow:'58,18 62,15'}}},
    {id:'seated_rotation',name:'Seated Trunk Rotation',bodyPart:'back',frame1:{headX:45,headY:12,hipX:45,hipY:52,lElbow:[35,35],lHand:[30,45],rElbow:[55,35],rHand:[60,45],lKnee:[38,72],lFoot:[35,92],rKnee:[52,72],rFoot:[55,92],hl:[],props:{chair:'28,48 28,95 62,95 62,48',surface:[10,98,90,98]}},frame2:{headX:48,headY:12,hipX:45,hipY:52,lElbow:[40,35],lHand:[50,42],rElbow:[58,32],rHand:[68,38],lKnee:[38,72],lFoot:[35,92],rKnee:[52,72],rFoot:[55,92],hl:[],props:{chair:'28,48 28,95 62,95 62,48',surface:[10,98,90,98],arrow:'62,38 68,38'}}},
    {id:'chin_tuck',name:'Chin Tuck',bodyPart:'neck',frame1:{headX:52,headY:15,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102]}},frame2:{headX:48,headY:15,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102],arrow:'52,18 48,18'}}},
    {id:'neck_side_bend',name:'Neck Side Bend',bodyPart:'neck',frame1:{headX:50,headY:12,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102]}},frame2:{headX:42,headY:14,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102],arrow:'48,12 42,14'}}},
    {id:'neck_rotation',name:'Neck Rotation',bodyPart:'neck',frame1:{headX:50,headY:12,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102]}},frame2:{headX:46,headY:12,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102],arrow:'50,10 46,10'}}},
    {id:'neck_isometric_forward',name:'Isometric Neck (Forward)',bodyPart:'neck',frame1:{headX:50,headY:12,hipX:50,hipY:52,lElbow:[40,35],lHand:[44,18],rElbow:[60,35],rHand:[56,18],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102]}},frame2:{headX:50,headY:12,hipX:50,hipY:52,lElbow:[40,35],lHand:[44,12],rElbow:[60,35],rHand:[56,12],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:['lArm','rArm'],props:{surface:[15,102,85,102]}}},
    {id:'neck_isometric_side',name:'Isometric Neck (Side)',bodyPart:'neck',frame1:{headX:50,headY:12,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[62,25],rHand:[60,12],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:['rArm'],props:{surface:[15,102,85,102]}},frame2:{headX:50,headY:12,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[62,22],rHand:[58,10],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:['rArm'],props:{surface:[15,102,85,102]}}},
    {id:'upper_trap_stretch',name:'Upper Trap Stretch',bodyPart:'neck',frame1:{headX:50,headY:12,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102]}},frame2:{headX:42,headY:14,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,25],rHand:[55,12],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:['rArm'],props:{surface:[15,102,85,102],arrow:'48,12 42,14'}}},
    {id:'neck_flexion',name:'Neck Flexion Stretch',bodyPart:'neck',frame1:{headX:50,headY:12,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102]}},frame2:{headX:50,headY:18,hipX:50,hipY:52,lElbow:[40,40],lHand:[35,52],rElbow:[60,40],rHand:[65,52],lKnee:[44,76],lFoot:[42,98],rKnee:[56,76],rFoot:[58,98],hl:[],props:{surface:[15,102,85,102],arrow:'50,14 50,18'}}},
    {id:'ankle_circle',name:'Ankle Circle',bodyPart:'ankle',frame1:{headX:40,headY:15,hipX:40,hipY:55,lElbow:[30,45],lHand:[25,55],rElbow:[50,45],rHand:[55,55],lKnee:[35,75],lFoot:[35,95],rKnee:[48,72],rFoot:[55,88],hl:['rLeg'],props:{chair:'25,50 25,98 55,98 55,50',surface:[10,102,90,102]}},frame2:{headX:40,headY:15,hipX:40,hipY:55,lElbow:[30,45],lHand:[25,55],rElbow:[50,45],rHand:[55,55],lKnee:[35,75],lFoot:[35,95],rKnee:[48,72],rFoot:[48,85],hl:['rLeg'],props:{chair:'25,50 25,98 55,98 55,50',surface:[10,102,90,102],arrow:'52,90 48,85'}}},
    {id:'toe_raise',name:'Toe Raise (Dorsiflexion)',bodyPart:'ankle',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[40,35],lHand:[35,45],rElbow:[60,35],rHand:[65,45],lKnee:[45,72],lFoot:[43,95],rKnee:[55,72],rFoot:[57,95],hl:['lLeg','rLeg'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[40,35],lHand:[35,45],rElbow:[60,35],rHand:[65,45],lKnee:[45,72],lFoot:[40,92],rKnee:[55,72],rFoot:[53,92],hl:['lLeg','rLeg'],props:{surface:[15,100,85,100],arrow:'47,96 44,92'}}},
    {id:'towel_scrunch',name:'Towel Scrunch (Toe Curl)',bodyPart:'ankle',frame1:{headX:42,headY:15,hipX:42,hipY:55,lElbow:[32,45],lHand:[28,55],rElbow:[52,45],rHand:[58,55],lKnee:[36,75],lFoot:[34,95],rKnee:[50,75],rFoot:[50,95],hl:['rLeg'],props:{chair:'25,50 25,98 58,98 58,50',surface:[10,100,90,100]}},frame2:{headX:42,headY:15,hipX:42,hipY:55,lElbow:[32,45],lHand:[28,55],rElbow:[52,45],rHand:[58,55],lKnee:[36,75],lFoot:[34,95],rKnee:[50,75],rFoot:[48,94],hl:['rLeg'],props:{chair:'25,50 25,98 58,98 58,50',surface:[10,100,90,100]}}},
    {id:'single_leg_balance',name:'Single Leg Balance',bodyPart:'ankle',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,35],rHand:[70,45],lKnee:[45,72],lFoot:[43,95],rKnee:[55,72],rFoot:[57,95],hl:['lLeg'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[35,30],lHand:[25,35],rElbow:[65,30],rHand:[75,35],lKnee:[45,72],lFoot:[43,95],rKnee:[58,60],rFoot:[55,65],hl:['lLeg'],props:{surface:[15,100,85,100]}}},
    {id:'ankle_dorsiflexion_band',name:'Resistance Band Dorsiflexion',bodyPart:'ankle',frame1:{headX:25,headY:25,hipX:42,hipY:40,lElbow:[30,28],lHand:[35,22],rElbow:[50,30],rHand:[56,24],lKnee:[55,42],lFoot:[70,45],rKnee:[55,42],rFoot:[70,45],hl:['rLeg'],props:{mat:[10,48,80,4]}},frame2:{headX:25,headY:25,hipX:42,hipY:40,lElbow:[30,28],lHand:[35,22],rElbow:[50,30],rHand:[56,24],lKnee:[55,42],lFoot:[70,38],rKnee:[55,42],rFoot:[70,45],hl:['rLeg'],props:{mat:[10,48,80,4],arrow:'70,44 70,38'}}},
    {id:'heel_toe_walk',name:'Heel-Toe Walk',bodyPart:'ankle',frame1:{headX:45,headY:8,hipX:45,hipY:45,lElbow:[35,30],lHand:[30,40],rElbow:[55,30],rHand:[60,40],lKnee:[38,68],lFoot:[32,92],rKnee:[52,68],rFoot:[58,92],hl:['lLeg','rLeg'],props:{surface:[10,98,90,98]}},frame2:{headX:48,headY:8,hipX:48,hipY:45,lElbow:[38,30],lHand:[33,40],rElbow:[58,30],rHand:[63,40],lKnee:[42,65],lFoot:[38,85],rKnee:[55,70],rFoot:[58,92],hl:['lLeg','rLeg'],props:{surface:[10,98,90,98],arrow:'38,90 38,85'}}},
    {id:'clamshell',name:'Clamshell',bodyPart:'hip',frame1:{headX:18,headY:35,hipX:48,hipY:42,lElbow:[25,28],lHand:[28,22],rElbow:[38,32],rHand:[42,28],lKnee:[55,28],lFoot:[48,22],rKnee:[55,55],rFoot:[48,62],hl:['lLeg'],props:{mat:[5,48,85,4]}},frame2:{headX:18,headY:35,hipX:48,hipY:42,lElbow:[25,28],lHand:[28,22],rElbow:[38,32],rHand:[42,28],lKnee:[58,18],lFoot:[50,12],rKnee:[55,55],rFoot:[48,62],hl:['lLeg'],props:{mat:[5,48,85,4],arrow:'56,25 58,18'}}},
    {id:'hip_flexor_stretch',name:'Hip Flexor Stretch (Lunge)',bodyPart:'hip',frame1:{headX:45,headY:8,hipX:45,hipY:45,lElbow:[35,30],lHand:[30,40],rElbow:[55,30],rHand:[60,40],lKnee:[38,68],lFoot:[35,92],rKnee:[55,68],rFoot:[58,92],hl:['rLeg'],props:{surface:[10,98,90,98]}},frame2:{headX:45,headY:8,hipX:45,hipY:48,lElbow:[35,32],lHand:[30,42],rElbow:[55,32],rHand:[60,42],lKnee:[30,68],lFoot:[25,92],rKnee:[62,72],rFoot:[72,92],hl:['rLeg'],props:{surface:[10,98,90,98],arrow:'60,75 65,80'}}},
    {id:'glute_bridge_hip',name:'Glute Bridge',bodyPart:'hip',frame1:{headX:15,headY:40,hipX:42,hipY:42,lElbow:[22,38],lHand:[28,35],rElbow:[50,38],rHand:[56,35],lKnee:[55,24],lFoot:[62,42],rKnee:[58,26],rFoot:[65,44],hl:['lLeg','rLeg'],props:{mat:[5,48,85,4]}},frame2:{headX:15,headY:40,hipX:42,hipY:28,lElbow:[22,38],lHand:[28,35],rElbow:[50,32],rHand:[56,28],lKnee:[55,22],lFoot:[62,42],rKnee:[58,24],rFoot:[65,44],hl:['lLeg','rLeg'],props:{mat:[5,48,85,4],arrow:'42,40 42,28'}}},
    {id:'side_lying_leg_raise',name:'Side-Lying Leg Raise',bodyPart:'hip',frame1:{headX:15,headY:38,hipX:50,hipY:42,lElbow:[22,30],lHand:[20,22],rElbow:[38,35],rHand:[40,28],lKnee:[60,48],lFoot:[75,45],rKnee:[60,50],rFoot:[75,48],hl:['lLeg'],props:{mat:[5,52,85,4]}},frame2:{headX:15,headY:38,hipX:50,hipY:42,lElbow:[22,30],lHand:[20,22],rElbow:[38,35],rHand:[40,28],lKnee:[60,30],lFoot:[75,25],rKnee:[60,50],rFoot:[75,48],hl:['lLeg'],props:{mat:[5,52,85,4],arrow:'68,38 72,28'}}},
    {id:'figure_4_stretch',name:'Figure-4 Stretch',bodyPart:'hip',frame1:{headX:18,headY:35,hipX:42,hipY:40,lElbow:[25,30],lHand:[30,24],rElbow:[50,32],rHand:[55,26],lKnee:[52,24],lFoot:[58,38],rKnee:[56,26],rFoot:[62,40],hl:['lLeg'],props:{mat:[5,45,85,4]}},frame2:{headX:18,headY:35,hipX:42,hipY:40,lElbow:[30,26],lHand:[38,22],rElbow:[50,28],rHand:[55,22],lKnee:[50,20],lFoot:[55,28],rKnee:[55,22],rFoot:[62,38],hl:['lLeg'],props:{mat:[5,45,85,4],arrow:'52,26 50,20'}}},
    {id:'standing_hip_abduction',name:'Standing Hip Abduction',bodyPart:'hip',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[40,35],lHand:[35,45],rElbow:[60,35],rHand:[65,45],lKnee:[45,72],lFoot:[43,95],rKnee:[55,72],rFoot:[57,95],hl:['rLeg'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[40,35],lHand:[35,45],rElbow:[60,35],rHand:[65,45],lKnee:[45,72],lFoot:[43,95],rKnee:[68,65],rFoot:[78,80],hl:['rLeg'],props:{surface:[15,100,85,100],arrow:'68,78 78,80'}}},
    {id:'fire_hydrant',name:'Fire Hydrant',bodyPart:'hip',frame1:{headX:22,headY:32,hipX:65,hipY:35,lElbow:[18,55],lHand:[18,72],rElbow:[30,55],rHand:[30,72],lKnee:[58,55],lFoot:[58,72],rKnee:[72,55],rFoot:[72,72],hl:['rLeg'],props:{mat:[5,75,80,4]}},frame2:{headX:22,headY:32,hipX:65,hipY:35,lElbow:[18,55],lHand:[18,72],rElbow:[30,55],rHand:[30,72],lKnee:[58,55],lFoot:[58,72],rKnee:[82,40],rFoot:[85,55],hl:['rLeg'],props:{mat:[5,75,80,4],arrow:'78,48 82,40'}}},
    {id:'hip_circle',name:'Standing Hip Circle',bodyPart:'hip',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[40,35],lHand:[35,45],rElbow:[60,35],rHand:[65,45],lKnee:[45,72],lFoot:[43,95],rKnee:[58,62],rFoot:[62,75],hl:['rLeg'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[40,35],lHand:[35,45],rElbow:[60,35],rHand:[65,45],lKnee:[45,72],lFoot:[43,95],rKnee:[55,58],rFoot:[50,68],hl:['rLeg'],props:{surface:[15,100,85,100],arrow:'58,68 55,62'}}},
    {id:'wrist_curl',name:'Wrist Curl (Flexion)',bodyPart:'wrist',frame1:{headX:42,headY:15,hipX:42,hipY:55,lElbow:[32,45],lHand:[28,55],rElbow:[55,42],rHand:[62,52],lKnee:[36,75],lFoot:[34,95],rKnee:[50,75],rFoot:[52,95],hl:['rArm'],props:{chair:'25,50 25,98 58,98 58,50',surface:[10,100,90,100]}},frame2:{headX:42,headY:15,hipX:42,hipY:55,lElbow:[32,45],lHand:[28,55],rElbow:[55,42],rHand:[62,42],lKnee:[36,75],lFoot:[34,95],rKnee:[50,75],rFoot:[52,95],hl:['rArm'],props:{chair:'25,50 25,98 58,98 58,50',surface:[10,100,90,100],arrow:'62,50 62,42'}}},
    {id:'wrist_extension',name:'Wrist Extension',bodyPart:'wrist',frame1:{headX:42,headY:15,hipX:42,hipY:55,lElbow:[32,45],lHand:[28,55],rElbow:[55,42],rHand:[62,42],lKnee:[36,75],lFoot:[34,95],rKnee:[50,75],rFoot:[52,95],hl:['rArm'],props:{chair:'25,50 25,98 58,98 58,50',surface:[10,100,90,100]}},frame2:{headX:42,headY:15,hipX:42,hipY:55,lElbow:[32,45],lHand:[28,55],rElbow:[55,42],rHand:[62,52],lKnee:[36,75],lFoot:[34,95],rKnee:[50,75],rFoot:[52,95],hl:['rArm'],props:{chair:'25,50 25,98 58,98 58,50',surface:[10,100,90,100],arrow:'62,44 62,52'}}},
    {id:'finger_spread',name:'Finger Spread',bodyPart:'wrist',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,35],rHand:[70,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,30],rHand:[72,32],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}}},
    {id:'grip_squeeze',name:'Grip Squeeze (Ball)',bodyPart:'wrist',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,35],rHand:[70,42],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,32],rHand:[70,38],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}}},
    {id:'wrist_circle',name:'Wrist Circle',bodyPart:'wrist',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,32],rHand:[72,35],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,32],rHand:[72,28],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100],arrow:'72,34 72,28'}}},
    {id:'prayer_stretch',name:'Prayer Stretch',bodyPart:'wrist',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[48,28],rElbow:[62,35],rHand:[52,28],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,40],lHand:[48,35],rElbow:[62,40],rHand:[52,35],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100],arrow:'50,30 50,35'}}},
    {id:'short_arc_quad',name:'Short Arc Quad (VMO)',bodyPart:'knee',frame1:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[60,50],lFoot:[68,68],rKnee:[60,50],rFoot:[68,68],hl:['rLeg'],props:{mat:[10,38,80,4]}},frame2:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[60,50],lFoot:[68,68],rKnee:[62,45],rFoot:[75,38],hl:['rLeg'],props:{mat:[10,38,80,4],arrow:'72,42 75,38'}}},
    {id:'static_quad_hold',name:'Static Quad Contraction',bodyPart:'knee',frame1:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[62,48],lFoot:[72,65],rKnee:[62,48],rFoot:[72,65],hl:['lLeg','rLeg'],props:{mat:[10,38,80,4]}},frame2:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[64,42],lFoot:[78,36],rKnee:[64,42],rFoot:[78,36],hl:['lLeg','rLeg'],props:{mat:[10,38,80,4]}}},
    {id:'seated_knee_extension',name:'Seated Knee Extension',bodyPart:'knee',frame1:{headX:30,headY:10,hipX:35,hipY:48,lElbow:[22,35],lHand:[18,45],rElbow:[45,35],rHand:[50,45],lKnee:[42,72],lFoot:[45,95],rKnee:[50,72],rFoot:[52,95],hl:['rLeg'],props:{chair:'15,42 15,98 55,98 55,42',surface:[10,100,90,100]}},frame2:{headX:30,headY:10,hipX:35,hipY:48,lElbow:[22,35],lHand:[18,45],rElbow:[45,35],rHand:[50,45],lKnee:[42,72],lFoot:[45,95],rKnee:[50,68],rFoot:[68,65],hl:['rLeg'],props:{chair:'15,42 15,98 55,98 55,42',surface:[10,100,90,100],arrow:'60,70 68,65'}}},
    {id:'standing_hamstring_curl',name:'Standing Hamstring Curl',bodyPart:'knee',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rLeg'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,55],hl:['rLeg'],props:{surface:[15,100,85,100],arrow:'58,65 58,55'}}},
    {id:'pillow_squeeze',name:'Pillow Squeeze (Adductor)',bodyPart:'knee',frame1:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[55,55],lFoot:[50,75],rKnee:[65,55],rFoot:[70,75],hl:['lLeg','rLeg'],props:{mat:[10,38,80,4]}},frame2:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[58,55],lFoot:[52,75],rKnee:[62,55],rFoot:[68,75],hl:['lLeg','rLeg'],props:{mat:[10,38,80,4]}}},
    {id:'sleeper_stretch',name:'Sleeper Stretch',bodyPart:'shoulder',frame1:{headX:20,headY:80,hipX:55,hipY:82,lElbow:[30,72],lHand:[35,60],rElbow:[42,72],rHand:[42,60],lKnee:[65,75],lFoot:[75,90],rKnee:[68,78],rFoot:[78,92],hl:['lArm'],props:{mat:[8,85,82,4]}},frame2:{headX:20,headY:80,hipX:55,hipY:82,lElbow:[30,72],lHand:[30,90],rElbow:[42,72],rHand:[38,88],lKnee:[65,75],lFoot:[75,90],rKnee:[68,78],rFoot:[78,92],hl:['lArm'],props:{mat:[8,85,82,4],arrow:'34,65 32,85'}}},
    {id:'doorway_pec_stretch',name:'Doorway Pec Stretch',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[30,22],lHand:[20,10],rElbow:[70,22],rHand:[80,10],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{wall:[18,2,18,98],surface:[15,100,85,100]}},frame2:{headX:55,headY:10,hipX:55,hipY:48,lElbow:[30,22],lHand:[20,10],rElbow:[72,22],rHand:[82,10],lKnee:[49,72],lFoot:[47,95],rKnee:[61,72],rFoot:[63,95],hl:['lArm','rArm'],props:{wall:[18,2,18,98],surface:[15,100,85,100],arrow:'50,30 55,30'}}},
    {id:'band_pull_apart',name:'Band Pull Apart',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,28],lHand:[38,32],rElbow:[62,28],rHand:[62,32],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[30,28],lHand:[18,32],rElbow:[70,28],rHand:[82,32],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100]}}},
    {id:'prone_y_raise',name:'Prone Y Raise',bodyPart:'shoulder',frame1:{headX:25,headY:78,hipX:55,hipY:80,lElbow:[18,70],lHand:[12,65],rElbow:[18,85],rHand:[12,90],lKnee:[68,80],lFoot:[82,82],rKnee:[72,82],rFoot:[86,84],hl:['lArm','rArm'],props:{mat:[5,83,85,4]}},frame2:{headX:25,headY:75,hipX:55,hipY:80,lElbow:[15,62],lHand:[8,50],rElbow:[15,88],rHand:[8,95],lKnee:[68,80],lFoot:[82,82],rKnee:[72,82],rFoot:[86,84],hl:['lArm','rArm'],props:{mat:[5,83,85,4],arrow:'10,60 8,50'}}},
    {id:'shoulder_flexion_wand',name:'Shoulder Flexion with Wand',bodyPart:'shoulder',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[36,35],lHand:[30,42],rElbow:[64,35],rHand:[70,42],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[36,15],lHand:[32,2],rElbow:[64,15],rHand:[68,2],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100],arrow:'50,15 50,5'}}},
    {id:'superman',name:'Superman',bodyPart:'back',frame1:{headX:22,headY:78,hipX:50,hipY:80,lElbow:[15,72],lHand:[8,78],rElbow:[15,85],rHand:[8,88],lKnee:[65,80],lFoot:[80,82],rKnee:[70,82],rFoot:[85,84],hl:['lArm','rArm','lLeg','rLeg'],props:{mat:[3,84,90,4]}},frame2:{headX:18,headY:70,hipX:50,hipY:80,lElbow:[10,62],lHand:[4,55],rElbow:[10,75],rHand:[4,68],lKnee:[68,74],lFoot:[85,68],rKnee:[72,76],rFoot:[88,70],hl:['lArm','rArm','lLeg','rLeg'],props:{mat:[3,84,90,4]}}},
    {id:'mckenzie_press_up',name:'McKenzie Press-Up',bodyPart:'back',frame1:{headX:22,headY:78,hipX:55,hipY:82,lElbow:[28,80],lHand:[25,85],rElbow:[38,82],rHand:[35,87],lKnee:[68,82],lFoot:[82,84],rKnee:[72,84],rFoot:[86,86],hl:['back'],props:{mat:[5,86,85,4]}},frame2:{headX:25,headY:58,hipX:55,hipY:82,lElbow:[32,72],lHand:[30,82],rElbow:[42,74],rHand:[40,84],lKnee:[68,82],lFoot:[82,84],rKnee:[72,84],rFoot:[86,86],hl:['back'],props:{mat:[5,86,85,4],arrow:'28,68 25,60'}}},
    {id:'knee_rolls',name:'Knee Rolls (Windshield Wipers)',bodyPart:'back',frame1:{headX:20,headY:84,hipX:45,hipY:80,lElbow:[10,78],lHand:[5,72],rElbow:[30,78],rHand:[35,72],lKnee:[55,60],lFoot:[55,78],rKnee:[58,62],rFoot:[58,80],hl:['lLeg','rLeg'],props:{mat:[5,86,80,4]}},frame2:{headX:20,headY:84,hipX:45,hipY:80,lElbow:[10,78],lHand:[5,72],rElbow:[30,78],rHand:[35,72],lKnee:[65,68],lFoot:[72,82],rKnee:[68,70],rFoot:[75,84],hl:['lLeg','rLeg'],props:{mat:[5,86,80,4]}}},
    {id:'plank',name:'Plank Hold',bodyPart:'back',frame1:{headX:18,headY:68,hipX:50,hipY:72,lElbow:[22,78],lHand:[18,82],rElbow:[28,80],rHand:[24,84],lKnee:[65,72],lFoot:[82,74],rKnee:[68,74],rFoot:[85,76],hl:[],props:{mat:[5,82,85,4]}},frame2:{headX:18,headY:66,hipX:50,hipY:70,lElbow:[22,76],lHand:[18,80],rElbow:[28,78],rHand:[24,82],lKnee:[65,70],lFoot:[82,72],rKnee:[68,72],rFoot:[85,74],hl:[],props:{mat:[5,82,85,4]}}},
    {id:'side_plank',name:'Side Plank',bodyPart:'back',frame1:{headX:22,headY:30,hipX:50,hipY:60,lElbow:[25,55],lHand:[22,75],rElbow:[35,20],rHand:[38,8],lKnee:[62,72],lFoot:[78,82],rKnee:[65,75],rFoot:[80,85],hl:[],props:{surface:[10,88,90,88]}},frame2:{headX:22,headY:28,hipX:50,hipY:56,lElbow:[25,52],lHand:[22,72],rElbow:[35,18],rHand:[38,5],lKnee:[62,68],lFoot:[78,78],rKnee:[65,71],rFoot:[80,81],hl:[],props:{surface:[10,88,90,88]}}},
    {id:'levator_scap_stretch',name:'Levator Scapulae Stretch',bodyPart:'neck',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['neck'],props:{surface:[15,100,85,100]}},frame2:{headX:44,headY:12,hipX:50,hipY:48,lElbow:[38,35],lHand:[42,8],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['neck'],props:{surface:[15,100,85,100],arrow:'48,8 44,12'}}},
    {id:'scm_stretch',name:'SCM Stretch',bodyPart:'neck',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['neck'],props:{surface:[15,100,85,100]}},frame2:{headX:55,headY:8,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['neck'],props:{surface:[15,100,85,100]}}},
    {id:'neck_retraction_overpressure',name:'Neck Retraction + Overpressure',bodyPart:'neck',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['neck'],props:{surface:[15,100,85,100]}},frame2:{headX:48,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[55,18],rHand:[50,6],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['neck','rArm'],props:{surface:[15,100,85,100],arrow:'50,8 48,10'}}},
    {id:'calf_stretch_wall',name:'Wall Calf Stretch',bodyPart:'ankle',frame1:{headX:40,headY:10,hipX:45,hipY:48,lElbow:[30,22],lHand:[22,12],rElbow:[52,22],rHand:[22,14],lKnee:[38,68],lFoot:[35,95],rKnee:[55,72],rFoot:[62,95],hl:['rLeg'],props:{wall:[18,2,18,98],surface:[15,100,85,100]}},frame2:{headX:38,headY:10,hipX:42,hipY:48,lElbow:[28,22],lHand:[22,12],rElbow:[50,22],rHand:[22,14],lKnee:[36,68],lFoot:[33,95],rKnee:[52,72],rFoot:[65,95],hl:['rLeg'],props:{wall:[18,2,18,98],surface:[15,100,85,100]}}},
    {id:'ankle_pump',name:'Ankle Pump',bodyPart:'ankle',frame1:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[62,42],lFoot:[78,38],rKnee:[62,42],rFoot:[78,38],hl:['lLeg','rLeg'],props:{mat:[10,38,80,4]}},frame2:{headX:25,headY:30,hipX:50,hipY:35,lElbow:[35,25],lHand:[40,18],rElbow:[60,28],rHand:[68,22],lKnee:[62,42],lFoot:[78,44],rKnee:[62,42],rFoot:[78,44],hl:['lLeg','rLeg'],props:{mat:[10,38,80,4],arrow:'78,40 78,44'}}},
    {id:'band_eversion',name:'Resistance Band Eversion',bodyPart:'ankle',frame1:{headX:30,headY:10,hipX:35,hipY:48,lElbow:[22,35],lHand:[18,45],rElbow:[45,35],rHand:[50,45],lKnee:[40,72],lFoot:[40,95],rKnee:[50,72],rFoot:[50,95],hl:['rLeg'],props:{chair:'15,42 15,98 55,98 55,42',surface:[10,100,90,100]}},frame2:{headX:30,headY:10,hipX:35,hipY:48,lElbow:[22,35],lHand:[18,45],rElbow:[45,35],rHand:[50,45],lKnee:[40,72],lFoot:[40,95],rKnee:[50,72],rFoot:[56,95],hl:['rLeg'],props:{chair:'15,42 15,98 55,98 55,42',surface:[10,100,90,100],arrow:'52,95 56,95'}}},
    {id:'band_inversion',name:'Resistance Band Inversion',bodyPart:'ankle',frame1:{headX:30,headY:10,hipX:35,hipY:48,lElbow:[22,35],lHand:[18,45],rElbow:[45,35],rHand:[50,45],lKnee:[40,72],lFoot:[42,95],rKnee:[50,72],rFoot:[52,95],hl:['rLeg'],props:{chair:'15,42 15,98 55,98 55,42',surface:[10,100,90,100]}},frame2:{headX:30,headY:10,hipX:35,hipY:48,lElbow:[22,35],lHand:[18,45],rElbow:[45,35],rHand:[50,45],lKnee:[40,72],lFoot:[42,95],rKnee:[50,72],rFoot:[46,95],hl:['rLeg'],props:{chair:'15,42 15,98 55,98 55,42',surface:[10,100,90,100],arrow:'50,95 46,95'}}},
    {id:'piriformis_stretch',name:'Piriformis Stretch (Figure 4 Seated)',bodyPart:'hip',frame1:{headX:30,headY:10,hipX:35,hipY:48,lElbow:[22,35],lHand:[18,45],rElbow:[45,35],rHand:[50,45],lKnee:[42,72],lFoot:[45,95],rKnee:[55,62],rFoot:[42,65],hl:['rLeg'],props:{chair:'15,42 15,98 55,98 55,42',surface:[10,100,90,100]}},frame2:{headX:32,headY:14,hipX:35,hipY:48,lElbow:[22,35],lHand:[18,45],rElbow:[45,35],rHand:[50,45],lKnee:[42,72],lFoot:[45,95],rKnee:[55,62],rFoot:[42,65],hl:['rLeg'],props:{chair:'15,42 15,98 55,98 55,42',surface:[10,100,90,100],arrow:'32,20 32,14'}}},
    {id:'butterfly_stretch',name:'Butterfly Stretch (Groin)',bodyPart:'hip',frame1:{headX:50,headY:20,hipX:50,hipY:55,lElbow:[38,50],lHand:[42,65],rElbow:[62,50],rHand:[58,65],lKnee:[30,65],lFoot:[45,72],rKnee:[70,65],rFoot:[55,72],hl:['lLeg','rLeg'],props:{mat:[15,75,70,4]}},frame2:{headX:50,headY:20,hipX:50,hipY:55,lElbow:[36,50],lHand:[35,62],rElbow:[64,50],rHand:[65,62],lKnee:[25,62],lFoot:[45,72],rKnee:[75,62],rFoot:[55,72],hl:['lLeg','rLeg'],props:{mat:[15,75,70,4]}}},
    {id:'it_band_stretch',name:'IT Band Stretch (Standing)',bodyPart:'hip',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rLeg'],props:{surface:[15,100,85,100]}},frame2:{headX:45,headY:10,hipX:48,hipY:48,lElbow:[33,22],lHand:[28,8],rElbow:[60,35],rHand:[65,45],lKnee:[40,72],lFoot:[38,95],rKnee:[52,72],rFoot:[35,95],hl:['rLeg'],props:{surface:[15,100,85,100]}}},
    {id:'monster_walk',name:'Monster Walk (Band)',bodyPart:'hip',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,32],lHand:[35,40],rElbow:[62,32],rHand:[65,40],lKnee:[38,72],lFoot:[34,95],rKnee:[62,72],rFoot:[66,95],hl:['lLeg','rLeg'],props:{surface:[10,100,90,100]}},frame2:{headX:52,headY:10,hipX:52,hipY:48,lElbow:[40,32],lHand:[37,40],rElbow:[64,32],rHand:[67,40],lKnee:[34,68],lFoot:[28,90],rKnee:[64,75],rFoot:[70,95],hl:['lLeg','rLeg'],props:{surface:[10,100,90,100]}}},
    {id:'thumb_opposition',name:'Thumb Opposition',bodyPart:'wrist',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,32],rHand:[70,38],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,30],rHand:[72,32],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}}},
    {id:'radial_ulnar_deviation',name:'Radial/Ulnar Deviation',bodyPart:'wrist',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,32],rHand:[72,28],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,32],rHand:[72,38],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}}},
    {id:'bicep_curl',name:'Bicep Curl',bodyPart:'elbow',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[68,45],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[62,35],rHand:[65,22],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100],arrow:'66,30 65,22'}}},
    {id:'tricep_extension',name:'Tricep Extension (Overhead)',bodyPart:'elbow',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[58,5],rHand:[52,18],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[32,45],rElbow:[58,5],rHand:[62,2],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100],arrow:'58,10 62,2'}}},
    {id:'forearm_pronation_supination',name:'Forearm Pronation/Supination',bodyPart:'elbow',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,32],rHand:[72,30],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,35],lHand:[30,45],rElbow:[62,32],rHand:[72,36],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['rArm'],props:{surface:[15,100,85,100]}}},
    {id:'tennis_elbow_stretch',name:'Tennis Elbow Stretch (Wrist Extensor)',bodyPart:'elbow',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,28],lHand:[35,38],rElbow:[55,28],rHand:[48,35],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,28],lHand:[35,42],rElbow:[48,28],rHand:[40,38],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100],arrow:'42,36 40,38'}}},
    {id:'golfer_elbow_stretch',name:'Golfer\'s Elbow Stretch (Wrist Flexor)',bodyPart:'elbow',frame1:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,28],lHand:[35,35],rElbow:[52,28],rHand:[42,30],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100]}},frame2:{headX:50,headY:10,hipX:50,hipY:48,lElbow:[38,28],lHand:[35,30],rElbow:[52,28],rHand:[42,25],lKnee:[44,72],lFoot:[42,95],rKnee:[56,72],rFoot:[58,95],hl:['lArm','rArm'],props:{surface:[15,100,85,100],arrow:'42,28 42,25'}}}
  ];

  function getById(id) {
    for (var i = 0; i < exercises.length; i++) {
      if (exercises[i].id === id) return exercises[i];
    }
    return null;
  }

  function lerp(a, b, t) { return a + (b - a) * t; }
  function lerpPose(f1, f2, t) {
    return {
      headX: lerp(f1.headX, f2.headX, t), headY: lerp(f1.headY, f2.headY, t),
      hipX: lerp(f1.hipX, f2.hipX, t), hipY: lerp(f1.hipY, f2.hipY, t),
      lElbow: [lerp(f1.lElbow[0], f2.lElbow[0], t), lerp(f1.lElbow[1], f2.lElbow[1], t)],
      lHand: [lerp(f1.lHand[0], f2.lHand[0], t), lerp(f1.lHand[1], f2.lHand[1], t)],
      rElbow: [lerp(f1.rElbow[0], f2.rElbow[0], t), lerp(f1.rElbow[1], f2.rElbow[1], t)],
      rHand: [lerp(f1.rHand[0], f2.rHand[0], t), lerp(f1.rHand[1], f2.rHand[1], t)],
      lKnee: [lerp(f1.lKnee[0], f2.lKnee[0], t), lerp(f1.lKnee[1], f2.lKnee[1], t)],
      lFoot: [lerp(f1.lFoot[0], f2.lFoot[0], t), lerp(f1.lFoot[1], f2.lFoot[1], t)],
      rKnee: [lerp(f1.rKnee[0], f2.rKnee[0], t), lerp(f1.rKnee[1], f2.rKnee[1], t)],
      rFoot: [lerp(f1.rFoot[0], f2.rFoot[0], t), lerp(f1.rFoot[1], f2.rFoot[1], t)]
    };
  }

  function renderExerciseSVG(exerciseId, size) {
    var ex = getById(exerciseId);
    if (!ex) return '';
    var s = size || 120;
    var uid = 'exanim_' + exerciseId + '_' + Math.random().toString(36).substr(2, 4);
    var mkId = 'ah_' + uid;
    var svgContent = '<defs><marker id="' + mkId + '" markerWidth="7" markerHeight="5" refX="6" refY="2.5" orient="auto"><polygon points="0 0, 7 2.5, 0 5" fill="#059669"/></marker></defs>';
    var f1 = ex.frame1;
    svgContent += drawFigure({headX:f1.headX,headY:f1.headY,hipX:f1.hipX,hipY:f1.hipY,lElbow:f1.lElbow,lHand:f1.lHand,rElbow:f1.rElbow,rHand:f1.rHand,lKnee:f1.lKnee,lFoot:f1.lFoot,rKnee:f1.rKnee,rFoot:f1.rFoot}, f1.hl, f1.props, mkId);
    var html = '<div class="exercise-anim" data-exid="' + exerciseId + '" data-uid="' + uid + '">';
    html += '<svg id="' + uid + '" viewBox="0 0 100 120" width="' + s + '" height="' + s + '" xmlns="http://www.w3.org/2000/svg">' + svgContent + '</svg></div>';
    return html;
  }

  var _animFrame = null, _animStart = 0, _lastRedraw = 0;

  function startAnimations() {
    stopAnimations();
    _animStart = Date.now();
    _lastRedraw = 0;
    function tick() {
      var now = Date.now();
      if (now - _lastRedraw < 33) { _animFrame = requestAnimationFrame(tick); return; }
      _lastRedraw = now;
      var anims = document.querySelectorAll('.exercise-anim');
      if (anims.length === 0) { _animFrame = requestAnimationFrame(tick); return; }
      var cycle = 2200;
      var elapsed = (now - _animStart) % cycle;
      var t = elapsed / (cycle / 2);
      if (t > 1) t = 2 - t;
      t = (1 - Math.cos(t * Math.PI)) / 2;
      for (var i = 0; i < anims.length; i++) {
        var el = anims[i];
        var exId = el.getAttribute('data-exid');
        var uid = el.getAttribute('data-uid');
        var ex = getById(exId);
        if (!ex) continue;
        var svgEl = document.getElementById(uid);
        if (!svgEl) continue;
        var f1 = ex.frame1, f2 = ex.frame2;
        var pose = lerpPose(f1, f2, t);
        var hl = f1.hl || f2.hl || [];
        var props = {};
        var f1p = f1.props || {}, f2p = f2.props || {};
        if (f1p.mat || f2p.mat) props.mat = f1p.mat || f2p.mat;
        if (f1p.surface || f2p.surface) props.surface = f1p.surface || f2p.surface;
        if (f1p.wall || f2p.wall) props.wall = f1p.wall || f2p.wall;
        if (f1p.chair || f2p.chair) props.chair = f1p.chair || f2p.chair;
        if (t > 0.75 && f2p.arrow) props.arrow = f2p.arrow;
        var mkId = 'ah_' + uid;
        var content = '<defs><marker id="' + mkId + '" markerWidth="7" markerHeight="5" refX="6" refY="2.5" orient="auto"><polygon points="0 0, 7 2.5, 0 5" fill="#059669"/></marker></defs>';
        content += drawFigure(pose, hl, props, mkId);
        svgEl.innerHTML = content;
      }
      _animFrame = requestAnimationFrame(tick);
    }
    _animFrame = requestAnimationFrame(tick);
  }

  function stopAnimations() {
    if (_animFrame) { cancelAnimationFrame(_animFrame); _animFrame = null; }
  }

  return {
    getById: getById,
    drawFigure: drawFigure,
    renderExerciseSVG: renderExerciseSVG,
    startAnimations: startAnimations,
    stopAnimations: stopAnimations,
    setGender: setGender,
    getGender: getGender
  };
})();

// ===== Persistence =====
function saveSession() {
  localStorage.setItem('mobi_phone', state.phone);
  localStorage.setItem('mobi_phoneCode', state.phoneCode);
  localStorage.setItem('mobi_clinicId', state.clinicId);
  localStorage.setItem('mobi_patientId', state.patientId);
  localStorage.setItem('mobi_patientName', state.patientName);
  localStorage.setItem('mobi_clinicName', state.clinicName);
}

// ===== RENDER ENGINE =====
function render() {
  var app = document.getElementById('app');
  if (state.screen === 'loading') {
    app.innerHTML = '<div class="login-screen"><div class="spinner" style="width:40px;height:40px;border-width:4px;"></div><p style="color:rgba(255,255,255,0.8);margin-top:16px;">Loading...</p></div>';
    return;
  }
  if (state.screen === 'login') {
    renderLogin(app);
    return;
  }
  if (state.screen === 'clinicSelect') {
    renderClinicSelect(app);
    return;
  }
  if (state.screen === 'app') {
    renderApp(app);
    return;
  }
}

// ===== LOGIN SCREEN =====
function renderLogin(app) {
  var html = '<div class="login-screen">';
  html += '<div class="login-logo"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14h2v-4h-2v4zm0-6h2V8h-2v2z" fill="#075E54"/><path d="M12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z" fill="#075E54" opacity="0.3"/><path d="M12 8v4M8 12h8" stroke="#075E54" stroke-width="1.5" fill="none"/></svg></div>';
  html += '<div class="login-title">MobiPhysio</div>';
  html += '<div class="login-subtitle">Your health companion</div>';
  html += '<div class="login-card">';
  html += '<h3>Enter your phone number</h3>';
  html += '<div id="login-error" class="login-error"></div>';
  html += '<div class="form-group">';
  html += '<label>Phone Number</label>';
  html += '<div class="phone-input-row">';
  html += '<select id="phone-code">';
  html += '<option value="+91" selected>+91</option>';
  html += '<option value="+1">+1</option>';
  html += '<option value="+44">+44</option>';
  html += '<option value="+971">+971</option>';
  html += '</select>';
  html += '<input type="tel" id="phone-input" placeholder="9876543210" maxlength="10" inputmode="numeric" pattern="[0-9]*">';
  html += '</div></div>';
  html += '<button class="btn btn-primary" id="login-btn">Continue</button>';
  html += '<p style="text-align:center;font-size:0.78rem;color:var(--gray-400);margin-top:12px;">Enter the phone number registered with your clinic</p>';

  // Clinic code section (for patients without QR)
  if (!state._slugClinicId) {
    html += '<div style="margin-top:16px;text-align:center;">';
    html += '<a href="#" id="show-clinic-code" style="font-size:0.8rem;color:var(--wa-teal);text-decoration:underline;">Have a clinic code?</a>';
    html += '<div id="clinic-code-section" style="display:none;margin-top:10px;">';
    html += '<div class="form-group" style="margin-bottom:8px;">';
    html += '<label>Clinic Code</label>';
    html += '<input type="text" id="clinic-code-input" placeholder="e.g. 9092294466" inputmode="text" style="width:100%;padding:12px 14px;border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);font-size:1rem;outline:none;">';
    html += '</div>';
    html += '</div></div>';
  }

  html += '</div></div>';
  app.innerHTML = html;

  // Bind
  document.getElementById('login-btn').addEventListener('click', handleLogin);
  document.getElementById('phone-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleLogin();
  });

  // Clinic code toggle
  var showCodeLink = document.getElementById('show-clinic-code');
  if (showCodeLink) {
    showCodeLink.addEventListener('click', function(e) {
      e.preventDefault();
      var section = document.getElementById('clinic-code-section');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
      if (section.style.display === 'block') {
        document.getElementById('clinic-code-input').focus();
      }
    });
  }
}

function handleLogin() {
  var phoneInput = document.getElementById('phone-input');
  var phoneCode = document.getElementById('phone-code').value;
  var errorEl = document.getElementById('login-error');
  var phone = phoneInput.value.replace(/\D/g, '');

  // Check if user entered a clinic code manually
  var clinicCodeInput = document.getElementById('clinic-code-input');
  if (clinicCodeInput && clinicCodeInput.value.trim() && !state._slugClinicId) {
    var code = clinicCodeInput.value.trim();
    // Resolve the clinic code as a slug
    state._slugClinicId = code;
    errorEl.style.display = 'none';
    db.collection('booking_slugs').doc(code).get().then(function(doc) {
      if (doc.exists) {
        state._slugClinicId = doc.data().clinicId;
      } else {
        state._slugClinicId = code; // Try using code directly as clinicId
      }
      handleLogin(); // Re-run with slug resolved
    }).catch(function() {
      state._slugClinicId = code;
      handleLogin();
    });
    return;
  }

  if (phone.length < 7) {
    errorEl.textContent = 'Please enter a valid phone number';
    errorEl.style.display = 'block';
    return;
  }

  errorEl.style.display = 'none';
  var loginBtn = document.getElementById('login-btn');
  loginBtn.textContent = 'Looking up...';
  loginBtn.disabled = true;

  var norm = normalizePhone(phone, phoneCode);
  state.phone = phone;
  state.phoneCode = phoneCode;

  // Try phone index first
  db.collection('patient_phones').doc(norm).get().then(function(doc) {
    if (doc.exists && doc.data().clinics && doc.data().clinics.length > 0) {
      var clinics = doc.data().clinics;
      if (clinics.length === 1) {
        selectClinic(clinics[0]);
      } else {
        state.clinics = clinics;
        state.screen = 'clinicSelect';
        render();
      }
      return;
    }
    // Phone index not found  try direct patient lookup as fallback
    return directPatientLookup(phone, phoneCode, errorEl, loginBtn);
  }).catch(function(e) {
    console.error('Phone index error:', e);
    // Fallback to direct lookup
    return directPatientLookup(phone, phoneCode, errorEl, loginBtn);
  });
}

// Direct fallback: query clinic's patients collection by phone number
function directPatientLookup(phone, phoneCode, errorEl, loginBtn) {
  // If we have a clinicId from the URL slug, query that clinic's patients
  var clinicId = state._slugClinicId;
  if (!clinicId) {
    errorEl.textContent = 'No account found for this phone number. Please contact your clinic.';
    errorEl.style.display = 'block';
    loginBtn.textContent = 'Continue';
    loginBtn.disabled = false;
    return;
  }

  loginBtn.textContent = 'Searching clinic...';

  // Try multiple phone formats to match
  var queries = [];
  // Raw digits as entered
  queries.push(db.collection('clinics').doc(clinicId).collection('patients')
    .where('phone', '==', phone).limit(1).get());
  // With country code prefix
  var code = (phoneCode || '+91').replace('+', '');
  if (phone.indexOf(code) !== 0) {
    queries.push(db.collection('clinics').doc(clinicId).collection('patients')
      .where('phone', '==', code + phone).limit(1).get());
  }

  Promise.all(queries).then(function(results) {
    var foundPatient = null;
    for (var i = 0; i < results.length; i++) {
      if (!results[i].empty) {
        results[i].forEach(function(doc) { foundPatient = doc.data(); });
        break;
      }
    }

    if (!foundPatient) {
      errorEl.textContent = 'No account found for this phone number. Please contact your clinic.';
      errorEl.style.display = 'block';
      loginBtn.textContent = 'Continue';
      loginBtn.disabled = false;
      return;
    }

    // Get clinic name from clinic doc
    db.collection('clinics').doc(clinicId).get().then(function(clinicDoc) {
      var clinicName = 'PhysioClinic';
      if (clinicDoc.exists) {
        var cd = clinicDoc.data();
        clinicName = cd.name || cd.clinicName || clinicName;
      }
      selectClinic({
        clinicId: clinicId,
        clinicName: clinicName,
        patientId: foundPatient.id,
        patientName: foundPatient.name || ''
      });
    });
  }).catch(function(e) {
    console.error('Direct lookup error:', e);
    errorEl.textContent = 'Connection error. Please try again.';
    errorEl.style.display = 'block';
    loginBtn.textContent = 'Continue';
    loginBtn.disabled = false;
  });
}

// ===== CLINIC SELECT SCREEN =====
function renderClinicSelect(app) {
  var html = '<div class="login-screen">';
  html += '<div class="login-title">Select Clinic</div>';
  html += '<div class="login-subtitle">You are registered at multiple clinics</div>';
  html += '<div class="login-card">';
  html += '<h3>Choose a clinic</h3>';
  html += '<div class="clinic-list">';
  for (var i = 0; i < state.clinics.length; i++) {
    var c = state.clinics[i];
    html += '<div class="clinic-option" data-idx="' + i + '">';
    html += '<div class="clinic-option-name">' + escapeHtml(c.clinicName) + '</div>';
    html += '<div class="clinic-option-detail">Patient: ' + escapeHtml(c.patientName) + '</div>';
    html += '</div>';
  }
  html += '</div></div></div>';
  app.innerHTML = html;

  // Bind clinic selection
  var opts = app.querySelectorAll('.clinic-option');
  for (var j = 0; j < opts.length; j++) {
    opts[j].addEventListener('click', function() {
      var idx = parseInt(this.getAttribute('data-idx'), 10);
      selectClinic(state.clinics[idx]);
    });
  }
}

function selectClinic(clinic) {
  state.clinicId = clinic.clinicId;
  state.patientId = clinic.patientId;
  state.patientName = clinic.patientName;
  state.clinicName = clinic.clinicName;
  saveSession();
  state.screen = 'app';
  state.dataLoaded = false;
  render();
  loadData();
}

// ===== LOAD DATA FROM FIRESTORE =====
function loadData() {
  var cid = state.clinicId;
  var pid = state.patientId;
  var today = todayStr();

  // Load clinic doc (real-time for feature toggles)
  state._unsubClinic = db.collection('clinics').doc(cid).onSnapshot(function(doc) {
    state.clinicDoc = doc.exists ? doc.data() : {};
    if (state.clinicDoc.name || state.clinicDoc.clinicName) {
      state.clinicName = state.clinicDoc.name || state.clinicDoc.clinicName;
      localStorage.setItem('mobi_clinicName', state.clinicName);
    }
    render();
  });

  // Load patient doc for tags, diagnosis, etc.
  db.collection('clinics').doc(cid).collection('patients').doc(pid).get().then(function(doc) {
    if (doc.exists) {
      var data = doc.data();
      state.patientDoc = data;
      state.patientTags = data.tags || [];
      state.patientDiagnosis = data.diagnosis || '';
      state.patientGender = data.gender || 'neutral';
      state.patientName = data.name || state.patientName;
      localStorage.setItem('mobi_patientName', state.patientName);
    }
    render();
  });

  // Load sessions (for review context)
  db.collection('clinics').doc(cid).collection('sessions')
    .where('patientId', '==', pid)
    .get().then(function(snap) {
      state.sessions = [];
      snap.forEach(function(doc) { state.sessions.push(doc.data()); });
      render();
    });

  // Load appointments (future)
  db.collection('clinics').doc(cid).collection('appointments')
    .where('patientId', '==', pid)
    .get().then(function(snap) {
      state.appointments = [];
      snap.forEach(function(doc) {
        var d = doc.data();
        if (d.date >= today && d.status !== 'cancelled') state.appointments.push(d);
      });
      state.appointments.sort(function(a,b) { return a.date < b.date ? -1 : a.date > b.date ? 1 : (a.time||'').localeCompare(b.time||''); });
      render();
    });

  // Load billing
  db.collection('clinics').doc(cid).collection('billing')
    .where('patientId', '==', pid)
    .get().then(function(snap) {
      state.bills = [];
      snap.forEach(function(doc) { state.bills.push(doc.data()); });
      state.bills.sort(function(a,b) { return (b.date||'').localeCompare(a.date||''); });
      state.dataLoaded = true;
      render();
    });

  // Load prescriptions
  db.collection('clinics').doc(cid).collection('prescriptions')
    .where('patientId', '==', pid)
    .get().then(function(snap) {
      state.prescriptions = [];
      snap.forEach(function(doc) { state.prescriptions.push(doc.data()); });
      state.prescriptions.sort(function(a,b) { return (b.date||'').localeCompare(a.date||''); });
      render();
    });

  // Load patient messages
  db.collection('clinics').doc(cid).collection('patient_messages')
    .orderBy('sentAt', 'desc').limit(50)
    .get().then(function(snap) {
      state.messages = [];
      snap.forEach(function(doc) { state.messages.push(doc.data()); });
      render();
    }).catch(function() {
      // Index might not exist yet - try without ordering
      db.collection('clinics').doc(cid).collection('patient_messages')
        .get().then(function(snap) {
          state.messages = [];
          snap.forEach(function(doc) { state.messages.push(doc.data()); });
          state.messages.sort(function(a,b) { return (b.sentAt||'').localeCompare(a.sentAt||''); });
          render();
        });
    });

  // Cleanup previous listeners
  cleanupListeners();

  // Load exercises for this patient (real-time)
  state._unsubExercises = db.collection('clinics').doc(cid).collection('exercises')
    .where('patientId', '==', pid)
    .onSnapshot(function(snap) {
      state.exercises = [];
      snap.forEach(function(doc) {
        var d = doc.data();
        if (d._deleted) return; // Skip soft-deleted exercises
        d._id = doc.id;
        state.exercises.push(d);
      });
      // Sort by _id for stable ordering
      state.exercises.sort(function(a, b) { return (a._id || '').localeCompare(b._id || ''); });
      render();
    }, function(e) { console.log('[MobiPhysio] Exercises listener error:', e); });

  // Load exercise completion log (real-time)
  state._unsubExerciseLog = db.collection('clinics').doc(cid).collection('exercise_log').doc(pid)
    .onSnapshot(function(doc) {
      state.exerciseLog = doc.exists ? doc.data() : {};
      render();
    }, function(e) { console.log('[MobiPhysio] Exercise log listener error:', e); });
}

function cleanupListeners() {
  if (state._unsubClinic) { state._unsubClinic(); state._unsubClinic = null; }
  if (state._unsubExercises) { state._unsubExercises(); state._unsubExercises = null; }
  if (state._unsubExerciseLog) { state._unsubExerciseLog(); state._unsubExerciseLog = null; }
}

// ===== MAIN APP =====
function renderApp(app) {
  // Stop exercise animations before re-render
  ExLib.stopAnimations();

  var html = '';

  // Header
  html += '<div class="header" style="display:flex;align-items:center;justify-content:space-between;">';
  html += '<div>';
  html += '<div class="header-title">' + escapeHtml(state.clinicName) + '</div>';
  html += '<div class="header-subtitle">Hello, ' + escapeHtml(state.patientName) + '</div>';
  html += '</div>';
  html += '<button id="logout-btn" style="background:none;border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.85);font-size:0.72rem;padding:5px 10px;border-radius:16px;cursor:pointer;font-weight:600;-webkit-tap-highlight-color:transparent;">Logout</button>';
  html += '</div>';

  // Feature checks: mobileFeatures  web features  default on
  var showBilling = isMobileFeatureOn('billing');
  var showRx = isMobileFeatureOn('prescriptions');
  var showMessaging = isMobileFeatureOn('messaging');
  var showExercises = isMobileFeatureOn('exercises');

  // Content
  html += '<div class="content" id="content">';
  if (state.tab === 'home') html += renderHome();
  else if (state.tab === 'exercises' && showExercises) html += renderExercises();
  else if (state.tab === 'bills' && showBilling) html += renderBills();
  else if (state.tab === 'rx' && showRx) html += renderRx();
  else if (state.tab === 'messages' && showMessaging) html += renderMessages();
  else if (state.tab === 'review') html += renderReview();
  else html += renderHome();
  html += '</div>';

  // Tab bar
  var unreadCount = getUnreadCount();
  html += '<div class="tab-bar">';
  html += tabItem('home', 'Home', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>');
  if (showExercises) html += tabItem('exercises', 'Exercises', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>');
  if (showBilling) html += tabItem('bills', 'Bills', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>');
  if (showRx) html += tabItem('rx', 'Rx', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>');
  if (showMessaging) html += tabItem('messages', 'Messages', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>', unreadCount);
  html += tabItem('review', 'Review', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>');
  html += '</div>';

  app.innerHTML = html;

  // Detail overlay
  if (state.detailItem) {
    renderDetailOverlay();
  }

  bindAppEvents();

  // Start exercise animations when on exercises tab
  if (state.tab === 'exercises') {
    ExLib.setGender(state.patientGender || 'neutral');
    setTimeout(function() { ExLib.startAnimations(); }, 50);
  }

  // Mark messages as read when on messages tab
  if (state.tab === 'messages' && state.messages.length > 0) {
    state.lastReadTimestamp = state.messages[0].sentAt || new Date().toISOString();
    localStorage.setItem('mobi_lastRead', state.lastReadTimestamp);
  }
}

function tabItem(key, label, icon, badge) {
  var html = '<button class="tab-item' + (state.tab === key ? ' active' : '') + '" data-tab="' + key + '">';
  if (badge && badge > 0) html += '<span class="tab-badge">' + badge + '</span>';
  html += icon;
  html += '<span>' + label + '</span>';
  html += '</button>';
  return html;
}

function getUnreadCount() {
  if (!state.lastReadTimestamp) return state.messages.length;
  var count = 0;
  for (var i = 0; i < state.messages.length; i++) {
    var msg = state.messages[i];
    if (!messageMatchesPatient(msg)) continue;
    if (msg.sentAt > state.lastReadTimestamp) count++;
  }
  return count;
}

// ===== HOME TAB =====
function renderHome() {
  var html = '';
  var homeBilling = isMobileFeatureOn('billing');
  var homeRx = isMobileFeatureOn('prescriptions');
  var homeMessaging = isMobileFeatureOn('messaging');

  // Quick stats
  var stats = [];
  if (homeBilling) {
    var pendingBills = 0;
    for (var b = 0; b < state.bills.length; b++) {
      if (state.bills[b].status === 'pending') pendingBills++;
    }
    stats.push('<div class="stat-card"><div class="stat-num">' + pendingBills + '</div><div class="stat-label">Pending Bills</div></div>');
  }
  if (homeRx) {
    var activeRx = 0;
    for (var r = 0; r < state.prescriptions.length; r++) {
      if (state.prescriptions[r].status === 'active') activeRx++;
    }
    stats.push('<div class="stat-card"><div class="stat-num">' + activeRx + '</div><div class="stat-label">Active Rx</div></div>');
  }
  if (homeMessaging) {
    var unread = getUnreadCount();
    stats.push('<div class="stat-card"><div class="stat-num">' + unread + '</div><div class="stat-label">Messages</div></div>');
  }
  // Always show upcoming appointments count
  stats.push('<div class="stat-card"><div class="stat-num">' + state.appointments.length + '</div><div class="stat-label">Appointments</div></div>');

  html += '<div class="stats-row">';
  html += stats.join('');
  html += '</div>';

  // Progress chart (pain & function scores over sessions)
  if (state.sessions.length >= 2) {
    var chartS = state.sessions.slice().sort(function(a,b) { return (a.date||'').localeCompare(b.date||''); });
    var hasScores = false;
    for (var hs = 0; hs < chartS.length; hs++) {
      if (chartS[hs].painScore !== undefined) { hasScores = true; break; }
    }
    if (hasScores) {
      html += '<div class="section-title">Your Progress</div>';
      html += '<div class="card"><div class="card-body">';
      html += '<div style="display:flex;gap:12px;margin-bottom:6px;font-size:0.7rem;">';
      html += '<span><span style="display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:50%;vertical-align:-1px;margin-right:3px;"></span>Pain</span>';
      html += '<span><span style="display:inline-block;width:8px;height:8px;background:#22c55e;border-radius:50%;vertical-align:-1px;margin-right:3px;"></span>Function</span>';
      html += '</div>';
      var cw = 100, ch = 60;
      var pts = chartS.slice(-12);
      var stepX = pts.length > 1 ? cw / (pts.length - 1) : cw;
      var painLine = '', funcLine = '', dots = '';
      for (var cp = 0; cp < pts.length; cp++) {
        var px = Math.round(cp * stepX);
        var painY = Math.round(ch - ((pts[cp].painScore || 0) / 10) * ch);
        var funcY = Math.round(ch - ((pts[cp].functionScore || 0) / 10) * ch);
        painLine += px + ',' + painY + ' ';
        funcLine += px + ',' + funcY + ' ';
        dots += '<circle cx="' + px + '" cy="' + painY + '" r="2.5" fill="#ef4444"/>';
        dots += '<circle cx="' + px + '" cy="' + funcY + '" r="2.5" fill="#22c55e"/>';
      }
      html += '<svg viewBox="-2 -5 104 70" style="width:100%;height:100px;" preserveAspectRatio="none">';
      html += '<line x1="0" y1="0" x2="100" y2="0" stroke="#e5e7eb" stroke-width="0.3"/>';
      html += '<line x1="0" y1="' + (ch/2) + '" x2="100" y2="' + (ch/2) + '" stroke="#e5e7eb" stroke-width="0.3"/>';
      html += '<line x1="0" y1="' + ch + '" x2="100" y2="' + ch + '" stroke="#e5e7eb" stroke-width="0.3"/>';
      html += '<polyline points="' + painLine.trim() + '" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
      html += '<polyline points="' + funcLine.trim() + '" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
      html += dots;
      html += '</svg>';
      html += '<div style="display:flex;justify-content:space-between;font-size:0.65rem;color:var(--gray-400);">';
      html += '<span>' + formatDate(pts[0].date) + '</span>';
      html += '<span>' + formatDate(pts[pts.length-1].date) + '</span>';
      html += '</div>';
      html += '</div></div>';
    }
  }

  // Upcoming appointments
  html += '<div class="section-title">Upcoming Appointments</div>';
  if (state.appointments.length === 0) {
    html += '<div class="card"><div class="card-body"><div class="empty-state"><p>No upcoming appointments</p></div></div></div>';
  } else {
    var shown = Math.min(state.appointments.length, 3);
    for (var a = 0; a < shown; a++) {
      var appt = state.appointments[a];
      var dateParts = (appt.date || '').split('-');
      var months = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      html += '<div class="card"><div class="card-body"><div class="appt-card">';
      html += '<div class="appt-date"><div class="appt-date-day">' + parseInt(dateParts[2]||0,10) + '</div><div class="appt-date-month">' + (months[parseInt(dateParts[1]||0,10)]||'') + '</div></div>';
      html += '<div class="appt-info"><div class="appt-time">' + formatTime(appt.time) + '</div><div class="appt-type">' + escapeHtml(appt.type || 'Appointment') + ' &middot; ' + (appt.duration||30) + ' min</div></div>';
      html += '</div></div></div>';
    }
  }

  // Recent bills summary (only if billing enabled for patient app)
  if (homeBilling) {
    html += '<div class="section-title">Recent Activity</div>';
    var recentBills = state.bills.slice(0, 3);
    if (recentBills.length === 0) {
      html += '<div class="card"><div class="card-body"><div class="empty-state"><p>No billing history yet</p></div></div></div>';
    } else {
      for (var rb = 0; rb < recentBills.length; rb++) {
        var bill = recentBills[rb];
        var statusClass = bill.status === 'paid' ? 'badge-paid' : 'badge-pending';
        html += '<div class="card bill-card"><div class="card-body">';
        html += '<div class="bill-top"><span class="bill-amount">' + formatCurrency(bill.amount) + '</span><span class="badge ' + statusClass + '">' + escapeHtml(bill.status) + '</span></div>';
        html += '<div class="bill-desc">' + escapeHtml(bill.description) + '</div>';
        html += '<div class="bill-date">' + formatDate(bill.date) + '</div>';
        html += '</div></div>';
      }
    }
  }

  return html;
}

// ===== EXERCISES TAB =====
// Backwards-compat helper: extract done exercise indices from log entry
// Old format: { "2026-02-17": [0, 2, 5] }
// New format: { "2026-02-17": { "0": { sets: 3, pain: 1 }, "2": { sets: 3 } } }
function getDoneIndices(log, date) {
  var entry = (log || {})[date];
  if (!entry) return [];
  if (Array.isArray(entry)) return entry;
  return Object.keys(entry).map(Number);
}

function getExerciseStreak() {
  var log = state.exerciseLog || {};
  var streak = 0;
  var d = new Date();
  while (true) {
    var ds = d.getFullYear() + '-' + ('0' + (d.getMonth()+1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
    var done = getDoneIndices(log, ds);
    if (done.length > 0) {
      streak++;
      d.setDate(d.getDate() - 1);
    } else {
      break;
    }
  }
  return streak;
}

// Timer circle SVG helper
function timerCircleSVG(progress, isRest) {
  var circumference = 2 * Math.PI * 60;
  var offset = circumference * (1 - progress);
  return '<svg viewBox="0 0 140 140">' +
    '<circle class="ex-timer-circle-bg" cx="70" cy="70" r="60"/>' +
    '<circle class="ex-timer-circle-fg' + (isRest ? ' rest' : '') + '" cx="70" cy="70" r="60" ' +
    'stroke-dasharray="' + circumference.toFixed(1) + '" stroke-dashoffset="' + offset.toFixed(1) + '"/>' +
    '</svg>';
}

function renderTimerView(ex, timer) {
  var html = '<div class="ex-timer-view">';
  html += '<div class="ex-timer-set-counter">Set ' + timer.currentSet + ' of ' + timer.totalSets + '</div>';

  if (timer.phase === 'reps') {
    var reps = parseInt(ex.reps, 10) || 10;
    html += '<div class="ex-timer-reps-prompt">Do ' + reps + ' reps</div>';
    html += '<div style="margin-bottom:16px;">' + timerCircleSVG(1, false) + '</div>';
    html += '<button class="ex-timer-btn ex-timer-btn-primary" data-timer-action="doneSet">Done with Set</button>';
  } else if (timer.phase === 'hold') {
    var totalHold = parseInt(ex.hold, 10) || 30;
    var progress = timer.timeLeft / totalHold;
    html += '<div class="ex-timer-phase">Hold</div>';
    html += '<div class="ex-timer-circle-wrap">' + timerCircleSVG(progress, false);
    html += '<div class="ex-timer-time">' + timer.timeLeft + '</div>';
    html += '</div>';
    html += '<button class="ex-timer-btn-skip" data-timer-action="skipHold">Skip</button>';
  } else if (timer.phase === 'rest') {
    html += '<div class="ex-timer-phase">Rest</div>';
    var progress = timer.timeLeft / 30;
    html += '<div class="ex-timer-circle-wrap">' + timerCircleSVG(progress, true);
    html += '<div class="ex-timer-time">' + timer.timeLeft + '</div>';
    html += '</div>';
    html += '<button class="ex-timer-btn-skip" data-timer-action="skipRest">Skip Rest</button>';
  }

  html += '<div style="margin-top:12px;"><button class="ex-timer-btn-skip" data-timer-action="cancel">Cancel</button></div>';
  html += '</div>';
  return html;
}

function startTimer(seconds, onTick, onDone) {
  if (state._activeExTimer && state._activeExTimer.timerInterval) {
    clearInterval(state._activeExTimer.timerInterval);
  }
  state._activeExTimer.timeLeft = seconds;
  var interval = setInterval(function() {
    state._activeExTimer.timeLeft--;
    if (state._activeExTimer.timeLeft <= 0) {
      clearInterval(interval);
      state._activeExTimer.timerInterval = null;
      if (onDone) onDone();
    } else {
      if (onTick) onTick();
    }
  }, 1000);
  state._activeExTimer.timerInterval = interval;
}

function startExerciseTimer(exIdx) {
  var ex = state.exercises[exIdx];
  if (!ex) return;
  var totalSets = parseInt(ex.sets, 10) || 1;
  var hasHold = ex.hold && parseInt(ex.hold, 10) > 0;
  var hasReps = ex.reps && parseInt(ex.reps, 10) > 0;

  state._activeExTimer = {
    exIdx: exIdx,
    currentSet: 1,
    totalSets: totalSets,
    phase: hasHold ? 'hold' : 'reps',
    timeLeft: hasHold ? parseInt(ex.hold, 10) : 0,
    timerInterval: null
  };
  state._expandedExIdx = exIdx;

  if (hasHold) {
    startTimer(parseInt(ex.hold, 10), function() { render(); }, function() { advanceTimerSet(); });
  }
  render();
}

function advanceTimerSet() {
  var timer = state._activeExTimer;
  if (!timer) return;
  var ex = state.exercises[timer.exIdx];
  if (!ex) return;

  if (timer.currentSet >= timer.totalSets) {
    // All sets done
    finishTimerExercise();
    return;
  }

  // Start rest phase
  timer.phase = 'rest';
  timer.timeLeft = 30;
  render();
  startTimer(30, function() { render(); }, function() { startNextSet(); });
}

function startNextSet() {
  var timer = state._activeExTimer;
  if (!timer) return;
  var ex = state.exercises[timer.exIdx];
  if (!ex) return;

  timer.currentSet++;
  var hasHold = ex.hold && parseInt(ex.hold, 10) > 0;
  timer.phase = hasHold ? 'hold' : 'reps';
  timer.timeLeft = hasHold ? parseInt(ex.hold, 10) : 0;

  if (hasHold) {
    render();
    startTimer(parseInt(ex.hold, 10), function() { render(); }, function() { advanceTimerSet(); });
  } else {
    render();
  }
}

function finishTimerExercise() {
  var timer = state._activeExTimer;
  if (!timer) return;
  if (timer.timerInterval) { clearInterval(timer.timerInterval); timer.timerInterval = null; }
  var exIdx = timer.exIdx;
  state._activeExTimer = null;
  showPainFeedback(exIdx);
}

function cancelTimer() {
  if (state._activeExTimer) {
    if (state._activeExTimer.timerInterval) clearInterval(state._activeExTimer.timerInterval);
    state._activeExTimer = null;
    render();
  }
}

function showPainFeedback(exIdx) {
  var overlay = document.createElement('div');
  overlay.className = 'pain-overlay';
  overlay.id = 'pain-overlay';
  overlay.innerHTML = '<div class="pain-sheet">' +
    '<div class="pain-title">How did that feel?</div>' +
    '<div class="pain-subtitle">' + escapeHtml(state.exercises[exIdx].name) + '</div>' +
    '<div class="pain-emojis">' +
    '<button class="pain-emoji-btn" data-pain="0"><span class="emoji">\uD83D\uDE0A</span><span class="label">Easy</span></button>' +
    '<button class="pain-emoji-btn" data-pain="1"><span class="emoji">\uD83D\uDE10</span><span class="label">Moderate</span></button>' +
    '<button class="pain-emoji-btn" data-pain="2"><span class="emoji">\uD83D\uDE23</span><span class="label">Painful</span></button>' +
    '</div>' +
    '<button class="pain-skip" id="pain-skip">Skip</button>' +
    '</div>';
  document.body.appendChild(overlay);

  function completeExercise(painValue) {
    var today = todayStr();
    if (!state.exerciseLog[today]) state.exerciseLog[today] = {};
    // Migrate old array format if present
    if (Array.isArray(state.exerciseLog[today])) {
      var arr = state.exerciseLog[today];
      var obj = {};
      for (var a = 0; a < arr.length; a++) { obj[String(arr[a])] = { sets: 1 }; }
      state.exerciseLog[today] = obj;
    }
    var entry = { sets: (state.exercises[exIdx].sets ? parseInt(state.exercises[exIdx].sets, 10) : 1), completedAt: new Date().toISOString() };
    if (painValue !== undefined && painValue !== null) entry.pain = painValue;
    state.exerciseLog[today][String(exIdx)] = entry;
    state._expandedExIdx = null;
    // Save to Firestore
    if (state.clinicId && state.patientId) {
      db.collection('clinics').doc(state.clinicId).collection('exercise_log').doc(state.patientId).set(state.exerciseLog).catch(function(e) {
        console.log('[MobiPhysio] Exercise log save error:', e);
      });
    }
    var doneToday = getDoneIndices(state.exerciseLog, today);
    if (doneToday.length >= state.exercises.length) {
      showToast('All exercises done! Great work! \uD83C\uDF89');
    } else {
      showToast('Exercise completed!');
    }
    overlay.remove();
    render();
    setTimeout(function() {
      var card = document.querySelector('.ex-card[data-ex-idx="' + exIdx + '"]');
      if (card) card.classList.add('ex-just-done');
    }, 50);
  }

  // Bind emoji buttons
  var painBtns = overlay.querySelectorAll('.pain-emoji-btn');
  for (var pb = 0; pb < painBtns.length; pb++) {
    painBtns[pb].addEventListener('click', function() {
      completeExercise(parseInt(this.getAttribute('data-pain'), 10));
    });
  }
  document.getElementById('pain-skip').addEventListener('click', function() {
    completeExercise(null);
  });
  // Close on overlay tap
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) completeExercise(null);
  });
}

function renderExercises() {
  var html = '';
  var today = todayStr();
  var doneToday = getDoneIndices(state.exerciseLog, today);
  var streak = getExerciseStreak();
  var totalEx = state.exercises.length;
  var doneCount = 0;
  for (var dc = 0; dc < doneToday.length; dc++) {
    if (doneToday[dc] < totalEx) doneCount++;
  }
  if (doneCount > totalEx) doneCount = totalEx;

  // Progress bar
  if (totalEx > 0) {
    var pct = Math.round((doneCount / totalEx) * 100);
    html += '<div class="ex-progress">';
    html += '<div class="ex-progress-label">';
    html += '<span>Today\'s Progress</span>';
    html += '<span class="ex-progress-count">' + doneCount + '/' + totalEx + ' done</span>';
    html += '</div>';
    html += '<div class="ex-progress-bar"><div class="ex-progress-fill" style="width:' + pct + '%;"></div></div>';
    html += '</div>';
  }

  // Streak banner
  html += '<div style="text-align:center;padding:14px 12px;background:linear-gradient(135deg,#f0fdfa 0%,#ecfdf5 100%);border-radius:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">';
  if (streak > 0) {
    html += '<div style="font-size:1.8rem;font-weight:800;color:var(--wa-dark);">Day ' + streak + ' \uD83D\uDD25</div>';
    html += '<div style="font-size:0.82rem;color:var(--gray-500);margin-top:2px;">Keep up the great work!</div>';
  } else {
    html += '<div style="font-size:1.2rem;font-weight:700;color:var(--wa-dark);">Start your streak!</div>';
    html += '<div style="font-size:0.82rem;color:var(--gray-500);margin-top:2px;">Complete an exercise to begin</div>';
  }
  html += '</div>';

  // All done congratulations
  if (totalEx > 0 && doneCount >= totalEx) {
    html += '<div style="text-align:center;padding:14px;background:#dcfce7;border-radius:12px;margin-bottom:12px;">';
    html += '<div style="font-size:1.1rem;font-weight:700;color:#16a34a;">\u2705 All exercises done today!</div>';
    html += '<div style="font-size:0.82rem;color:#15803d;margin-top:2px;">Great job! See you tomorrow.</div>';
    html += '</div>';
  }

  html += '<div class="section-title">Your Exercises</div>';

  if (totalEx === 0) {
    html += '<div class="card"><div class="card-body"><div class="empty-state">';
    html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;margin-bottom:8px;opacity:0.4;"><path d="M18 8h1a4 4 0 010 8h-1M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>';
    html += '<p>No exercises assigned yet</p>';
    html += '</div></div></div>';
    return html;
  }

  for (var i = 0; i < state.exercises.length; i++) {
    var ex = state.exercises[i];
    var isDone = false;
    for (var di = 0; di < doneToday.length; di++) {
      if (doneToday[di] === i) { isDone = true; break; }
    }
    var isTimerActive = state._activeExTimer && state._activeExTimer.exIdx === i;
    var isExpanded = ((state._expandedExIdx === i) || isTimerActive) && !isDone;

    // Sets/reps text (prominent)
    var setsRepsText = '';
    if (ex.sets && ex.reps) setsRepsText = ex.sets + ' sets \u00D7 ' + ex.reps + ' reps';
    else if (ex.reps) setsRepsText = ex.reps + ' reps';
    else if (ex.sets) setsRepsText = ex.sets + ' sets';
    if (ex.hold) setsRepsText += (setsRepsText ? ' \u00B7 ' : '') + 'Hold ' + ex.hold + 's';

    // Pain indicator for done exercises (new format)
    var painInfo = '';
    if (isDone && !Array.isArray((state.exerciseLog || {})[today])) {
      var logEntry = ((state.exerciseLog || {})[today] || {})[String(i)];
      if (logEntry && logEntry.pain !== undefined && logEntry.pain !== null) {
        var painEmojis = ['\uD83D\uDE0A', '\uD83D\uDE10', '\uD83D\uDE23'];
        painInfo = ' ' + (painEmojis[logEntry.pain] || '');
      }
    }

    // Get visual for the exercise
    var svgHtml = '';
    if (ex.imageUrl) {
      svgHtml = '<img src="' + escapeHtml(ex.imageUrl) + '" alt="' + escapeHtml(ex.name) + '" style="width:48px;height:48px;object-fit:cover;border-radius:6px;"/>';
    } else if (ex.libraryId && ExLib.getById(ex.libraryId)) {
      svgHtml = ExLib.renderExerciseSVG(ex.libraryId, 48);
    } else {
      svgHtml = '<svg viewBox="0 0 100 120" width="48" height="48" xmlns="http://www.w3.org/2000/svg">';
      svgHtml += '<ellipse cx="50" cy="18" rx="5.5" ry="5.5" fill="#94a3b8"/>';
      svgHtml += '<rect x="48" y="23" width="4" height="4" rx="2" fill="#94a3b8"/>';
      svgHtml += '<path d="M44.5,28 Q43.5,41 46,55 Q50,57.5 54,55 Q56.5,41 55.5,28Z" fill="#64748b"/>';
      svgHtml += '<path d="M49,55 Q42,72 38,95" fill="none" stroke="#64748b" stroke-width="5" stroke-linecap="round"/>';
      svgHtml += '<path d="M51,55 Q58,72 62,95" fill="none" stroke="#64748b" stroke-width="5" stroke-linecap="round"/>';
      svgHtml += '<path d="M44,30 Q35,45 28,40" fill="none" stroke="#64748b" stroke-width="4" stroke-linecap="round"/>';
      svgHtml += '<path d="M56,30 Q65,45 72,40" fill="none" stroke="#64748b" stroke-width="4" stroke-linecap="round"/>';
      svgHtml += '</svg>';
    }

    html += '<div class="ex-card' + (isDone ? ' ex-done' : '') + '" data-ex-idx="' + i + '">';

    // Header
    html += '<div class="ex-card-header" data-ex-toggle="' + i + '">';
    html += '<div class="ex-card-thumb">' + svgHtml + '</div>';
    html += '<div class="ex-card-info">';
    html += '<div class="ex-card-name">' + escapeHtml(ex.name) + painInfo + '</div>';
    if (setsRepsText) html += '<div class="ex-card-sets">' + escapeHtml(setsRepsText) + '</div>';
    html += '</div>';
    html += '<div class="ex-card-right">';
    if (isDone) {
      html += '<div class="ex-card-check">\u2713</div>';
    } else {
      html += '<svg class="ex-card-chevron' + (isExpanded ? ' open' : '') + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
    }
    html += '</div>';
    html += '</div>';

    // Expandable body
    if (!isDone) {
      html += '<div class="ex-card-body' + (isExpanded ? ' expanded' : '') + '">';
      html += '<div class="ex-card-body-inner">';

      if (isTimerActive) {
        // Show timer view
        html += renderTimerView(ex, state._activeExTimer);
      } else {
        if (ex.instructions) html += '<div class="ex-card-instructions">' + escapeHtml(ex.instructions) + '</div>';
        if (ex.frequency) html += '<div class="ex-card-freq">Frequency: ' + escapeHtml(ex.frequency) + '</div>';
        if (ex.videoUrl) html += '<a class="ex-card-video" href="' + escapeHtml(ex.videoUrl) + '" target="_blank" rel="noopener"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>Watch Video</a>';
        // Show Start Exercise button (with sets/hold) or simple Mark as Complete
        var hasSetsOrHold = (ex.sets && parseInt(ex.sets, 10) > 1) || (ex.hold && parseInt(ex.hold, 10) > 0);
        if (hasSetsOrHold) {
          html += '<button class="ex-complete-btn" data-start-timer="' + i + '"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> Start Exercise</button>';
        } else {
          html += '<button class="ex-complete-btn" data-complete-idx="' + i + '"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Mark as Complete</button>';
        }
      }

      html += '</div></div>';
    }

    html += '</div>';
  }

  return html;
}

// ===== BILLS TAB =====
function renderBills() {
  var html = '';
  html += '<div class="section-title">Your Invoices</div>';

  if (state.bills.length === 0) {
    html += '<div class="card"><div class="card-body"><div class="empty-state">';
    html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>';
    html += '<p>No invoices yet</p></div></div></div>';
    return html;
  }

  for (var i = 0; i < state.bills.length; i++) {
    var bill = state.bills[i];
    var statusBadge = 'badge-pending';
    var statusLabel = bill.status || 'pending';
    if (bill.status === 'paid') statusBadge = 'badge-paid';
    else if (bill.status === 'gpay') { statusBadge = 'badge-gpay'; statusLabel = 'GPay'; }
    else if (bill.status === 'card') { statusBadge = 'badge-card'; statusLabel = 'Card'; }
    else if (bill.status === 'cash') { statusBadge = 'badge-cash'; statusLabel = 'Cash'; }

    html += '<div class="card card-clickable bill-card" data-bill-idx="' + i + '"><div class="card-body">';
    html += '<div class="bill-top"><span class="bill-amount">' + formatCurrency(bill.amount) + '</span><span class="badge ' + statusBadge + '">' + escapeHtml(statusLabel) + '</span></div>';
    html += '<div class="bill-desc">' + escapeHtml(bill.description) + '</div>';
    html += '<div class="bill-date">' + formatDate(bill.date) + '</div>';
    html += '</div></div>';
  }
  return html;
}

// ===== RX TAB =====
function renderRx() {
  var html = '';
  html += '<div class="section-title">Your Prescriptions</div>';

  if (state.prescriptions.length === 0) {
    html += '<div class="card"><div class="card-body"><div class="empty-state">';
    html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2z"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>';
    html += '<p>No prescriptions yet</p></div></div></div>';
    return html;
  }

  for (var i = 0; i < state.prescriptions.length; i++) {
    var rx = state.prescriptions[i];
    var statusBadge = 'badge-active';
    if (rx.status === 'discontinued') statusBadge = 'badge-discontinued';
    else if (rx.status === 'completed') statusBadge = 'badge-completed';

    html += '<div class="card card-clickable rx-card" data-rx-idx="' + i + '"><div class="card-body">';
    html += '<div class="rx-top"><span class="rx-med">' + escapeHtml(rx.medication) + '</span><span class="badge ' + statusBadge + '">' + escapeHtml(rx.status || 'active') + '</span></div>';
    html += '<div class="rx-detail">';
    html += '<span>' + escapeHtml(rx.dosage) + '</span>';
    html += '<span>' + escapeHtml(rx.frequency) + '</span>';
    if (rx.duration) html += '<span>' + escapeHtml(rx.duration) + '</span>';
    html += '</div>';
    html += '<div style="font-size:0.75rem;color:var(--gray-400);margin-top:4px;">' + formatDate(rx.date) + (rx.prescribedBy ? ' &middot; ' + escapeHtml(rx.prescribedBy) : '') + '</div>';
    html += '</div></div>';
  }
  return html;
}

// ===== MESSAGES TAB =====
function messageMatchesPatient(msg) {
  // Patient-targeted messages (from compose)
  if (msg.targetPatients && msg.targetPatients.length > 0) {
    return msg.targetPatients.indexOf(state.patientId) !== -1;
  }
  // Tag-targeted messages (from campaigns)
  if (msg.targetTags && msg.targetTags.length > 0) {
    for (var t = 0; t < msg.targetTags.length; t++) {
      if (state.patientTags.indexOf(msg.targetTags[t]) !== -1) return true;
    }
    return false;
  }
  // No targeting = broadcast to all
  return true;
}

function renderMessages() {
  // Filter messages for this patient
  var filtered = [];
  for (var i = 0; i < state.messages.length; i++) {
    if (messageMatchesPatient(state.messages[i])) {
      filtered.push(state.messages[i]);
    }
  }

  var html = '';
  html += '<div class="section-title">Messages from ' + escapeHtml(state.clinicName) + '</div>';

  if (filtered.length === 0) {
    html += '<div class="card"><div class="card-body"><div class="empty-state">';
    html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>';
    html += '<p>No messages yet</p></div></div></div>';
    return html;
  }

  html += '<div class="chat-container">';
  // Show oldest first (reverse)
  for (var j = filtered.length - 1; j >= 0; j--) {
    var m = filtered[j];
    var typeClass = m.type === 'announcement' ? 'badge-announcement' : 'badge-campaign';
    html += '<div class="chat-bubble chat-bubble-received">';
    html += '<div class="chat-bubble-sender">' + escapeHtml(state.clinicName) + '</div>';
    if (m.type) {
      html += '<span class="chat-bubble-type ' + typeClass + '">' + escapeHtml(m.type) + '</span>';
    }
    html += '<div class="chat-bubble-text">' + escapeHtml(m.text) + '</div>';
    html += '<div class="chat-bubble-time">' + timeAgo(m.sentAt) + '</div>';
    html += '</div>';
  }
  html += '</div>';
  return html;
}

// ===== REVIEW TAB =====

// Extract location parts from address for SEO
// Input: "No.454, LIC Siva Complex, Vannakoil, Periyanaickenpalayam, Tamil Nadu 641047"
// Output: { area: "Periyanaickenpalayam", locality: "Vannakoil", state: "Tamil Nadu", full: "Periyanaickenpalayam, Tamil Nadu" }
function extractLocation(address, clinicDoc) {
  var result = { area: '', locality: '', state: '', full: '' };
  if (!address && !clinicDoc) return result;

  var addr = address || '';
  if (clinicDoc) {
    // Use clinic doc fields if available
    if (clinicDoc.city) result.area = clinicDoc.city;
    if (clinicDoc.state) result.state = clinicDoc.state;
    if (clinicDoc.locality) result.locality = clinicDoc.locality;
    if (clinicDoc.address && !addr) addr = clinicDoc.address;
  }

  if (addr) {
    var parts = addr.split(',');
    // Clean each part
    for (var i = 0; i < parts.length; i++) parts[i] = parts[i].trim();

    // Remove pin code from last part
    var lastPart = parts[parts.length - 1] || '';
    var stateMatch = lastPart.replace(/\d{6}/g, '').trim();

    // Indian states detection
    var states = ['Tamil Nadu','Kerala','Karnataka','Andhra Pradesh','Telangana','Maharashtra',
      'Gujarat','Rajasthan','Madhya Pradesh','Uttar Pradesh','Bihar','West Bengal','Odisha',
      'Punjab','Haryana','Delhi','Goa','Assam','Jharkhand','Chhattisgarh','Uttarakhand',
      'Himachal Pradesh','Jammu and Kashmir','Manipur','Meghalaya','Mizoram','Nagaland',
      'Sikkim','Tripura','Arunachal Pradesh'];

    for (var si = 0; si < states.length; si++) {
      if (stateMatch.toLowerCase().indexOf(states[si].toLowerCase()) !== -1) {
        result.state = states[si];
        break;
      }
    }

    // Area/town: typically second-to-last or third-to-last part (skip building/complex names)
    if (parts.length >= 3) {
      // Walk backwards: last is state+pin, before that is town/area, before that is locality
      var townIdx = result.state ? parts.length - 2 : parts.length - 1;
      if (townIdx >= 0) result.area = parts[townIdx].replace(/\d{6}/g, '').trim();
      if (townIdx - 1 >= 1) result.locality = parts[townIdx - 1].trim();
    } else if (parts.length === 2) {
      result.area = parts[0].replace(/\d+/g, '').trim();
    }
  }

  // Build full location string
  var locParts = [];
  if (result.area) locParts.push(result.area);
  if (result.state && result.state !== result.area) locParts.push(result.state);
  result.full = locParts.join(', ');

  return result;
}

function generateReviewSuggestions() {
  var clinic = state.clinicName;
  var diagnosis = state.patientDiagnosis || '';
  var sessionCount = state.sessions.length;
  var patientDoc = state.patientDoc || {};
  var clinicDoc = state.clinicDoc || {};
  var patientName = state.patientName || '';
  var firstName = patientName.split(' ')[0] || '';

  // Extract rich location data
  var clinicAddr = clinicDoc.address || '';
  var patientAddr = patientDoc.address || '';
  var loc = extractLocation(clinicAddr || patientAddr, clinicDoc);

  // SEO location phrases
  var inArea = loc.area ? ' in ' + loc.area : '';
  var inFull = loc.full ? ' in ' + loc.full : '';
  var nearArea = loc.locality ? ' near ' + loc.locality : '';
  var atLocation = loc.area ? ' at ' + loc.area : '';

  // Extract treatment area + SEO treatment keyword
  var area = '';
  var seoCondition = '';
  var seoTreatment = '';
  if (diagnosis) {
    var lower = diagnosis.toLowerCase();
    if (lower.indexOf('knee') !== -1) {
      area = 'knee'; seoCondition = 'knee pain'; seoTreatment = 'knee pain treatment';
    } else if (lower.indexOf('back') !== -1 || lower.indexOf('lumbar') !== -1 || lower.indexOf('spinal') !== -1 || lower.indexOf('spondyl') !== -1) {
      area = 'back'; seoCondition = 'back pain'; seoTreatment = 'back pain treatment';
    } else if (lower.indexOf('shoulder') !== -1 || lower.indexOf('frozen') !== -1 || lower.indexOf('rotator') !== -1) {
      area = 'shoulder'; seoCondition = 'shoulder pain'; seoTreatment = 'frozen shoulder treatment';
    } else if (lower.indexOf('neck') !== -1 || lower.indexOf('cervical') !== -1 || lower.indexOf('whiplash') !== -1) {
      area = 'neck'; seoCondition = 'neck pain'; seoTreatment = 'neck pain treatment';
    } else if (lower.indexOf('ankle') !== -1 || lower.indexOf('sprain') !== -1) {
      area = 'ankle'; seoCondition = 'ankle injury'; seoTreatment = 'ankle sprain treatment';
    } else if (lower.indexOf('hip') !== -1) {
      area = 'hip'; seoCondition = 'hip pain'; seoTreatment = 'hip pain treatment';
    } else if (lower.indexOf('elbow') !== -1 || lower.indexOf('tennis') !== -1 || lower.indexOf('golfer') !== -1) {
      area = 'elbow'; seoCondition = 'elbow pain'; seoTreatment = 'tennis elbow treatment';
    } else if (lower.indexOf('wrist') !== -1 || lower.indexOf('hand') !== -1 || lower.indexOf('carpal') !== -1) {
      area = 'hand/wrist'; seoCondition = 'wrist pain'; seoTreatment = 'carpal tunnel treatment';
    } else if (lower.indexOf('stroke') !== -1 || lower.indexOf('neuro') !== -1 || lower.indexOf('hemi') !== -1 || lower.indexOf('myelop') !== -1) {
      area = 'neurological'; seoCondition = 'neurological condition'; seoTreatment = 'neuro rehabilitation';
    } else if (lower.indexOf('acl') !== -1 || lower.indexOf('surgery') !== -1 || lower.indexOf('replace') !== -1 || lower.indexOf('post-op') !== -1) {
      area = 'post-surgery'; seoCondition = 'post-surgery recovery'; seoTreatment = 'post-surgical rehabilitation';
    } else if (lower.indexOf('plantar') !== -1 || lower.indexOf('heel') !== -1 || lower.indexOf('achilles') !== -1) {
      area = 'foot'; seoCondition = 'heel pain'; seoTreatment = 'plantar fasciitis treatment';
    } else if (lower.indexOf('sciatica') !== -1 || lower.indexOf('disc') !== -1 || lower.indexOf('herniat') !== -1) {
      area = 'sciatica'; seoCondition = 'sciatica'; seoTreatment = 'sciatica treatment';
    } else if (lower.indexOf('fibro') !== -1) {
      area = 'fibromyalgia'; seoCondition = 'fibromyalgia'; seoTreatment = 'fibromyalgia management';
    } else if (lower.indexOf('it band') !== -1 || lower.indexOf('patello') !== -1) {
      area = 'knee'; seoCondition = 'knee pain'; seoTreatment = 'sports injury treatment';
    } else if (lower.indexOf('thoracic') !== -1 || lower.indexOf('outlet') !== -1) {
      area = 'thoracic'; seoCondition = 'thoracic pain'; seoTreatment = 'thoracic outlet treatment';
    } else if (lower.indexOf('ankylos') !== -1) {
      area = 'spine'; seoCondition = 'spinal stiffness'; seoTreatment = 'ankylosing spondylitis treatment';
    } else {
      area = 'condition'; seoCondition = 'pain and mobility issues'; seoTreatment = 'physiotherapy treatment';
    }
  } else {
    seoCondition = 'pain and mobility issues'; seoTreatment = 'physiotherapy';
  }

  var sessionText = sessionCount > 3 ? 'After ' + sessionCount + ' sessions of physiotherapy, ' : '';
  var progressText = sessionCount > 5 ? 'I can already feel significant improvement. ' : sessionCount > 2 ? 'I\'m already seeing good progress. ' : '';

  // Get doctor/therapist names from sessions + prescriptions
  var therapists = {};
  for (var s = 0; s < state.sessions.length; s++) {
    if (state.sessions[s].therapist) therapists[state.sessions[s].therapist] = true;
  }
  for (var p = 0; p < state.prescriptions.length; p++) {
    if (state.prescriptions[p].prescribedBy) therapists[state.prescriptions[p].prescribedBy] = true;
  }
  // Also check clinic doc for owner/doctor name
  if (clinicDoc.ownerName) therapists[clinicDoc.ownerName] = true;
  if (clinicDoc.doctorName) therapists[clinicDoc.doctorName] = true;

  var therapistNames = Object.keys(therapists);
  var doctorName = therapistNames.length > 0 ? therapistNames[0] : 'the physiotherapist';
  var doctorShort = doctorName.replace(/^Dr\.?\s*/i, '').split(' ')[0]; // "Aarthi" from "Dr. Aarthi Ganesh"

  // Patient intro: "I, Rajesh," or "I" if no name
  var patientIntro = firstName ? 'I, ' + firstName + ',' : 'I';
  var myName = firstName ? 'As ' + firstName + ', I' : 'I';

  // 8 SEO-rich templates with patient name, doctor name, and location
  var templates = [
    {
      icon: '\uD83C\uDFAF',
      label: 'Treatment Results',
      text: sessionText + patientIntro + ' visited ' + clinic + inArea + ' for ' + seoTreatment + ' and I am very happy with the results. ' + doctorName + ' provided an excellent physiotherapy treatment plan that was well-structured. ' + progressText + 'Best physiotherapy clinic' + inFull + ' for ' + seoCondition + '. Highly recommended!'
    },
    {
      icon: '\uD83D\uDC68\u200D\u2695\uFE0F',
      label: 'Doctor & Expertise',
      text: doctorName + ' at ' + clinic + inArea + ' is one of the best physiotherapists I have consulted for ' + seoCondition + '. ' + myName + ' was impressed by ' + doctorShort + '\'s expertise in ' + seoTreatment + ' and their ability to explain the condition clearly. The personalized physiotherapy care' + atLocation + ' made all the difference in my recovery. Thank you ' + doctorName + '!'
    },
    {
      icon: '\uD83E\uDD1D',
      label: 'Personal Care',
      text: myName + ' have been visiting ' + clinic + inArea + ' for ' + seoTreatment + ' and the personal care is outstanding. ' + doctorName + ' remembers my progress, adjusts the physiotherapy treatment each session, and genuinely cares about recovery. Unlike other physiotherapy clinics' + inFull + ', here you feel truly cared for. ' + progressText + 'Highly recommend!'
    },
    {
      icon: '\uD83C\uDFE5',
      label: 'Clinic & Facilities',
      text: clinic + nearArea + inArea + ' is a well-equipped physiotherapy clinic with modern facilities. ' + doctorName + ' uses advanced physiotherapy techniques for ' + seoTreatment + '. ' + patientIntro + ' found the clinic clean, professional, and well-maintained. Easy appointment booking, minimal waiting. Top-rated physiotherapy centre' + inFull + '!'
    },
    {
      icon: '\uD83D\uDCAA',
      label: 'Recovery Story',
      text: sessionText + patientIntro + ' came to ' + clinic + inArea + ' suffering from ' + seoCondition + ' that was affecting my daily life. Thanks to ' + doctorName + '\'s expert physiotherapy treatment, ' + progressText.toLowerCase() + 'the combination of manual therapy, physiotherapy exercises, and home exercise program has been incredibly effective. Best ' + seoTreatment + ' clinic' + inFull + '!'
    },
    {
      icon: '\uD83C\uDF1F',
      label: 'Recommendation',
      text: myName + ' highly recommend ' + clinic + ' and ' + doctorName + ' to anyone looking for ' + seoTreatment + inArea + '. ' + (sessionCount > 0 ? 'After ' + sessionCount + ' physiotherapy sessions, I can confidently say this is the best physiotherapy clinic' + inFull + ' for ' + seoCondition + '. ' : '') + 'The quality of care, experienced physiotherapist, and visible results speak for themselves. Don\'t look further for physiotherapy' + inArea + '!'
    },
    {
      icon: '\uD83D\uDCD6',
      label: 'Rehab & Home Exercises',
      text: 'Beyond just treating ' + seoCondition + ', ' + doctorName + ' at ' + clinic + inArea + ' educated me on injury prevention and self-care. ' + patientIntro + ' received an excellent home exercise program and rehabilitation guidance for ' + seoTreatment + '. Their approach to physiotherapy' + atLocation + ' goes beyond pain relief \u2014 they focus on complete recovery and long-term wellness.'
    },
    {
      icon: '\u2764\uFE0F',
      label: 'Overall Experience',
      text: 'Five stars for ' + clinic + ' and ' + doctorName + '! ' + myName + ' can say this is the best physiotherapy clinic' + inFull + ' for ' + seoTreatment + '. From booking to treatment, everything was smooth and professional. The physiotherapy sessions have made a real difference in my quality of life. Thank you ' + doctorShort + ' and the entire team!'
    }
  ];

  return templates;
}

function getDailyTip() {
  var tips = [
    'Mention your city name and treatment type \u2014 it helps others nearby find the right care!',
    'Describe specific improvements you noticed \u2014 it helps others with similar conditions find this clinic.',
    'Mention "physiotherapy" and your condition in the review \u2014 it helps the clinic appear in Google searches.',
    'Personal recovery stories resonate most. How has the physiotherapy changed your daily life?',
    'Reviews that mention the therapist\'s name and treatment type are most helpful for other patients.',
    'Think about what you\'d search for on Google \u2014 those same words in your review help others find this clinic!',
    'Detailed reviews with your treatment experience help the clinic rank higher on Google Maps.'
  ];
  var dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
  return tips[dayOfYear % tips.length];
}

function renderReview() {
  var html = '';
  var clinicDoc = state.clinicDoc || {};
  var placeId = clinicDoc.googlePlaceId || '';
  var suggestions = generateReviewSuggestions();

  // Daily rotation: feature a different suggestion each day
  var dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
  var featuredIdx = dayOfYear % Math.min(suggestions.length, 8);

  // Header card
  html += '<div class="card"><div class="card-body review-section">';
  html += '<div class="review-stars">\u2B50\u2B50\u2B50\u2B50\u2B50</div>';
  html += '<h3 style="margin-bottom:4px;">Share Your Experience</h3>';
  html += '<p style="font-size:0.85rem;color:var(--gray-500);margin-bottom:4px;">Tap a suggestion below or write your own</p>';
  html += '</div></div>';

  // Daily tip
  html += '<div class="daily-tip"><strong>Tip of the day:</strong> ' + getDailyTip() + '</div>';

  // Suggestion cards
  html += '<div class="section-title">Pick a Review Template</div>';
  html += '<div class="review-suggestions">';

  // Show featured one first, then the rest
  var order = [featuredIdx];
  for (var oi = 0; oi < suggestions.length && oi < 8; oi++) {
    if (oi !== featuredIdx) order.push(oi);
  }

  for (var si = 0; si < order.length; si++) {
    var idx = order[si];
    var sug = suggestions[idx];
    var isFeatured = idx === featuredIdx;
    var isSelected = state._selectedReviewIdx === idx;
    html += '<div class="review-sug-card' + (isSelected ? ' selected' : '') + '" data-sug-idx="' + idx + '"' + (isFeatured ? ' style="border-color:var(--wa-green);"' : '') + '>';
    html += '<div class="sug-check">' + (isSelected ? '\u2713' : '') + '</div>';
    html += '<div class="sug-label"><span class="sug-icon">' + sug.icon + '</span> ' + escapeHtml(sug.label) + (isFeatured ? ' \u2014 Today\'s Pick' : '') + '</div>';
    html += '<div class="sug-text">' + escapeHtml(sug.text) + '</div>';
    html += '</div>';
  }
  html += '</div>';

  // Or write your own
  html += '<div class="review-or-divider">\u2014 or write your own \u2014</div>';
  html += '<div class="card" style="margin-bottom:12px;"><div class="card-body">';
  html += '<div class="review-custom-label">Your Review</div>';
  html += '<textarea class="review-textarea" id="review-text" placeholder="Write your own review here...">';
  // Pre-fill with selected suggestion or empty for custom
  if (typeof state._selectedReviewIdx === 'number' && suggestions[state._selectedReviewIdx]) {
    html += escapeHtml(suggestions[state._selectedReviewIdx].text);
  } else if (state._customReviewText) {
    html += escapeHtml(state._customReviewText);
  }
  html += '</textarea>';
  // Voice-to-text mic button
  if (_speechSupported) {
    html += '<button class="mic-btn' + (state._micListening ? ' mic-active' : '') + '" id="mic-btn">';
    html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="1" width="6" height="11" rx="3"/><path d="M19 10v1a7 7 0 01-14 0v-1"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
    html += state._micListening ? ' Listening...' : ' Tap to Speak';
    html += '</button>';
  }
  html += '</div></div>';

  // Copy & Post button
  if (placeId) {
    html += '<button class="btn-review" id="copy-review-btn">';
    html += '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>';
    html += ' Copy & Post on Google</button>';
  } else {
    html += '<div style="padding:12px;background:var(--gray-50);border-radius:8px;font-size:0.82rem;color:var(--gray-500);margin-top:12px;">Google reviews are not yet configured for this clinic.</div>';
  }

  return html;
}

// ===== DETAIL OVERLAY =====
function renderDetailOverlay() {
  var overlay = document.createElement('div');
  overlay.className = 'detail-overlay';
  overlay.id = 'detail-overlay';

  var html = '<div class="detail-sheet">';
  if (state.detailType === 'bill') {
    var bill = state.detailItem;
    html += '<h3>Invoice Details</h3>';
    html += detailRow('Description', bill.description);
    html += detailRow('Amount', formatCurrency(bill.amount));
    html += detailRow('Status', bill.status || 'pending');
    html += detailRow('Date', formatDate(bill.date));
    if (bill.paidDate) html += detailRow('Paid Date', formatDate(bill.paidDate));
  } else if (state.detailType === 'rx') {
    var rx = state.detailItem;
    html += '<h3>Prescription Details</h3>';
    html += detailRow('Medication', rx.medication);
    html += detailRow('Dosage', rx.dosage);
    if (rx.route) html += detailRow('Route', rx.route);
    html += detailRow('Frequency', rx.frequency);
    if (rx.duration) html += detailRow('Duration', rx.duration);
    html += detailRow('Status', rx.status || 'active');
    html += detailRow('Date', formatDate(rx.date));
    if (rx.prescribedBy) html += detailRow('Prescribed By', rx.prescribedBy);
    if (rx.instructions) {
      html += '<div style="margin-top:12px;padding:10px;background:var(--gray-50);border-radius:8px;font-size:0.85rem;">';
      html += '<div style="font-weight:600;margin-bottom:4px;color:var(--gray-600);">Instructions</div>';
      html += escapeHtml(rx.instructions);
      html += '</div>';
    }
  }
  html += '<div class="detail-close"><button id="close-detail">Close</button></div>';
  html += '</div>';

  overlay.innerHTML = html;
  document.body.appendChild(overlay);

  overlay.addEventListener('click', function(e) {
    if (e.target === overlay || e.target.closest('#close-detail')) {
      state.detailItem = null;
      state.detailType = null;
      overlay.remove();
    }
  });
}

function detailRow(label, value) {
  return '<div class="detail-row"><span class="detail-row-label">' + escapeHtml(label) + '</span><span class="detail-row-value">' + escapeHtml(value) + '</span></div>';
}

// ===== APP EVENT BINDING =====
function bindAppEvents() {
  // Logout
  var logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function() {
      cleanupListeners();
      localStorage.removeItem('mobi_phone');
      localStorage.removeItem('mobi_phoneCode');
      localStorage.removeItem('mobi_clinicId');
      localStorage.removeItem('mobi_patientId');
      localStorage.removeItem('mobi_patientName');
      localStorage.removeItem('mobi_clinicName');
      localStorage.removeItem('mobi_lastRead');
      state.phone = '';
      state.clinicId = '';
      state.patientId = '';
      state.patientName = '';
      state.clinicName = '';
      state.screen = 'login';
      state.tab = 'home';
      state.dataLoaded = false;
      render();
    });
  }

  // Tab navigation
  var tabs = document.querySelectorAll('.tab-item');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].addEventListener('click', function() {
      state.tab = this.getAttribute('data-tab');
      render();
    });
  }

  // Exercise card toggle (expand/collapse)
  var exToggles = document.querySelectorAll('[data-ex-toggle]');
  for (var et = 0; et < exToggles.length; et++) {
    exToggles[et].addEventListener('click', function() {
      var idx = parseInt(this.getAttribute('data-ex-toggle'), 10);
      // Don't toggle if timer is active for this exercise
      if (state._activeExTimer && state._activeExTimer.exIdx === idx) return;
      var today = todayStr();
      var doneToday = getDoneIndices(state.exerciseLog, today);
      for (var chk = 0; chk < doneToday.length; chk++) {
        if (doneToday[chk] === idx) return;
      }
      state._expandedExIdx = (state._expandedExIdx === idx) ? null : idx;
      render();
    });
  }

  // Start Exercise timer buttons
  var startTimerBtns = document.querySelectorAll('[data-start-timer]');
  for (var st = 0; st < startTimerBtns.length; st++) {
    startTimerBtns[st].addEventListener('click', function(e) {
      e.stopPropagation();
      var idx = parseInt(this.getAttribute('data-start-timer'), 10);
      startExerciseTimer(idx);
    });
  }

  // Timer action buttons (done set, skip rest, skip hold, cancel)
  var timerActionBtns = document.querySelectorAll('[data-timer-action]');
  for (var ta = 0; ta < timerActionBtns.length; ta++) {
    timerActionBtns[ta].addEventListener('click', function(e) {
      e.stopPropagation();
      var action = this.getAttribute('data-timer-action');
      if (action === 'doneSet') { advanceTimerSet(); }
      else if (action === 'skipRest') {
        if (state._activeExTimer && state._activeExTimer.timerInterval) {
          clearInterval(state._activeExTimer.timerInterval);
          state._activeExTimer.timerInterval = null;
        }
        startNextSet();
      }
      else if (action === 'skipHold') {
        if (state._activeExTimer && state._activeExTimer.timerInterval) {
          clearInterval(state._activeExTimer.timerInterval);
          state._activeExTimer.timerInterval = null;
        }
        advanceTimerSet();
      }
      else if (action === 'cancel') { cancelTimer(); }
    });
  }

  // Exercise complete buttons (simple exercises without timer)
  var exCompBtns = document.querySelectorAll('[data-complete-idx]');
  for (var ei = 0; ei < exCompBtns.length; ei++) {
    exCompBtns[ei].addEventListener('click', function(e) {
      e.stopPropagation();
      var idx = parseInt(this.getAttribute('data-complete-idx'), 10);
      // Show pain feedback (which handles the actual completion)
      showPainFeedback(idx);
    });
  }

  // Bill card click
  var billCards = document.querySelectorAll('[data-bill-idx]');
  for (var b = 0; b < billCards.length; b++) {
    billCards[b].addEventListener('click', function() {
      var idx = parseInt(this.getAttribute('data-bill-idx'), 10);
      state.detailItem = state.bills[idx];
      state.detailType = 'bill';
      renderDetailOverlay();
    });
  }

  // Rx card click
  var rxCards = document.querySelectorAll('[data-rx-idx]');
  for (var r = 0; r < rxCards.length; r++) {
    rxCards[r].addEventListener('click', function() {
      var idx = parseInt(this.getAttribute('data-rx-idx'), 10);
      state.detailItem = state.prescriptions[idx];
      state.detailType = 'rx';
      renderDetailOverlay();
    });
  }

  // Review suggestion card selection
  var sugCards = document.querySelectorAll('.review-sug-card');
  for (var sc = 0; sc < sugCards.length; sc++) {
    sugCards[sc].addEventListener('click', function() {
      var idx = parseInt(this.getAttribute('data-sug-idx'), 10);
      state._selectedReviewIdx = idx;
      state._customReviewText = null;
      render();
      // Scroll textarea into view
      setTimeout(function() {
        var ta = document.getElementById('review-text');
        if (ta) ta.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    });
  }

  // Review textarea custom input
  var reviewText = document.getElementById('review-text');
  if (reviewText) {
    reviewText.addEventListener('input', function() {
      state._customReviewText = this.value;
    });
  }

  // Mic button for voice-to-text
  var micBtn = document.getElementById('mic-btn');
  if (micBtn && _speechSupported) {
    micBtn.addEventListener('click', function() {
      if (state._micListening) {
        // Stop listening
        if (state._recognition) { state._recognition.stop(); state._recognition = null; }
        state._micListening = false;
        render();
        return;
      }
      var recognition = new SpeechRecognition();
      recognition.lang = 'en-IN';
      recognition.interimResults = false;
      recognition.continuous = false;
      recognition.maxAlternatives = 1;
      state._recognition = recognition;
      state._micListening = true;
      render();

      recognition.onresult = function(event) {
        var transcript = event.results[0][0].transcript;
        var ta = document.getElementById('review-text');
        if (ta) {
          var existing = ta.value;
          ta.value = existing ? existing + ' ' + transcript : transcript;
          state._customReviewText = ta.value;
          state._selectedReviewIdx = undefined;
        }
        state._micListening = false;
        state._recognition = null;
        render();
        showToast('Text added from speech');
      };
      recognition.onerror = function(event) {
        state._micListening = false;
        state._recognition = null;
        render();
        if (event.error === 'not-allowed') {
          showToast('Microphone permission denied');
        } else if (event.error === 'no-speech') {
          showToast('No speech detected. Try again.');
        } else {
          showToast('Speech error: ' + event.error);
        }
      };
      recognition.onend = function() {
        if (state._micListening) {
          state._micListening = false;
          state._recognition = null;
          render();
        }
      };
      recognition.start();
    });
  }

  // Copy & Post Review
  var copyReviewBtn = document.getElementById('copy-review-btn');
  if (copyReviewBtn) {
    copyReviewBtn.addEventListener('click', function() {
      var text = document.getElementById('review-text').value;
      if (!text.trim()) {
        showToast('Please select or write a review first');
        return;
      }
      var placeId = (state.clinicDoc || {}).googlePlaceId || '';
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function() {
          showToast('Review copied! Opening Google...');
          if (placeId) {
            setTimeout(function() {
              window.open('https://search.google.com/local/writereview?placeid=' + encodeURIComponent(placeId), '_blank');
            }, 500);
          }
        });
      } else {
        var tmp = document.createElement('textarea');
        tmp.value = text;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand('copy');
        document.body.removeChild(tmp);
        showToast('Review copied! Opening Google...');
        if (placeId) {
          setTimeout(function() {
            window.open('https://search.google.com/local/writereview?placeid=' + encodeURIComponent(placeId), '_blank');
          }, 500);
        }
      }
    });
  }
}

// ===== INIT =====
function init() {
  // Check for slug: try ?c= param, then #slug hash (file:// friendly)
  var urlParams = new URLSearchParams(window.location.search);
  var slug = urlParams.get('c');
  if (!slug && window.location.hash && window.location.hash.length > 1) {
    slug = window.location.hash.substring(1); // #9092294466 -> 9092294466
  }

  if (state.clinicId && state.patientId && state.phone) {
    // Already logged in
    state.screen = 'app';
    render();
    loadData();
  } else if (slug) {
    // Resolve slug to get clinic info, then show login
    state.screen = 'loading';
    render();
    db.collection('booking_slugs').doc(slug).get().then(function(doc) {
      if (doc.exists) {
        state._slugClinicId = doc.data().clinicId;
        console.log('[MobiPhysio] Resolved slug ' + slug + ' -> clinic ' + doc.data().clinicId);
      } else {
        console.log('[MobiPhysio] Slug not found: ' + slug + ', trying as clinicId...');
        state._slugClinicId = slug; // Try using slug directly as clinicId
      }
      state.screen = 'login';
      render();
    }).catch(function() {
      state._slugClinicId = slug;
      state.screen = 'login';
      render();
    });
  } else {
    // No slug  show login anyway, phone index lookup will be used
    state.screen = 'login';
    render();
  }
}

init();

})();
</script>

<!-- PWA: Service Worker + Install Prompt -->
<script>
(function() {
  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(function(reg) {
      console.log('[MobiPhysio] SW registered, scope:', reg.scope);
    }).catch(function(err) {
      console.log('[MobiPhysio] SW registration failed:', err);
    });
  }

  // Install prompt (Android/Chrome)
  var deferredPrompt = null;
  var bannerDismissed = sessionStorage.getItem('mobi_install_dismissed');

  window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredPrompt = e;
    if (!bannerDismissed) showInstallBanner();
  });

  window.addEventListener('appinstalled', function() {
    console.log('[MobiPhysio] App installed');
    hideInstallBanner();
    deferredPrompt = null;
  });

  function showInstallBanner() {
    // Don't show if already in standalone mode
    if (window.matchMedia('(display-mode: standalone)').matches) return;
    if (navigator.standalone) return; // iOS standalone

    var existing = document.getElementById('install-banner');
    if (existing) return;

    var banner = document.createElement('div');
    banner.className = 'install-banner';
    banner.id = 'install-banner';

    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    if (isIOS) {
      banner.innerHTML = '<img class="install-banner-icon" src="icon.svg" alt="MobiPhysio">'
        + '<div class="install-banner-text">'
        + '<div class="install-banner-title">Install MobiPhysio</div>'
        + '<div class="install-banner-desc">Tap <strong>Share</strong> then <strong>Add to Home Screen</strong></div>'
        + '</div>'
        + '<button class="install-banner-close" id="install-dismiss">&times;</button>';
    } else {
      banner.innerHTML = '<img class="install-banner-icon" src="icon.svg" alt="MobiPhysio">'
        + '<div class="install-banner-text">'
        + '<div class="install-banner-title">Install MobiPhysio</div>'
        + '<div class="install-banner-desc">Add to home screen for quick access</div>'
        + '</div>'
        + '<button class="install-banner-btn" id="install-btn">Install</button>'
        + '<button class="install-banner-close" id="install-dismiss">&times;</button>';
    }

    document.body.appendChild(banner);

    var installBtn = document.getElementById('install-btn');
    if (installBtn) {
      installBtn.addEventListener('click', function() {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then(function(result) {
            console.log('[MobiPhysio] Install choice:', result.outcome);
            deferredPrompt = null;
            hideInstallBanner();
          });
        }
      });
    }

    document.getElementById('install-dismiss').addEventListener('click', function() {
      sessionStorage.setItem('mobi_install_dismissed', '1');
      bannerDismissed = '1';
      hideInstallBanner();
    });
  }

  function hideInstallBanner() {
    var banner = document.getElementById('install-banner');
    if (banner) banner.remove();
  }

  // iOS: show install instructions on login screen after a delay
  var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  if (isIOS && !navigator.standalone && !bannerDismissed) {
    setTimeout(function() {
      if (!window.matchMedia('(display-mode: standalone)').matches) {
        showInstallBanner();
      }
    }, 3000);
  }
})();
</script>
</body>
</html>